<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æˆ‘æ˜¯è´ªåƒè›‡ ğŸ é©¬å¹´æ–°æ˜¥æœ€ç»ˆç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            background: linear-gradient(135deg, #fff8e6 0%, #ffe0b2 100%);
            font-family: "Comic Sans MS", "å¹¼åœ†", sans-serif;
            touch-action: none;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        /* é€šç”¨æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 12px 25px;
            font-size: 18px;
            border-radius: 50px;
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        /* éŸ³æ•ˆ/éŸ³ä¹å¼€å…³ */
        .audio-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 99;
        }

        .audio-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.9);
            border: 2px solid #e67e22;
            color: #e67e22;
            font-size: 20px;
            cursor: pointer;
        }

        /* æ¸¸æˆå¼•å¯¼é¡µ */
        #guide-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
            padding: 20px;
        }

        .guide-content {
            background: rgba(255,255,255,0.95);
            border-radius: 24px;
            padding: 30px;
            max-width: 400px;
            color: #333;
            text-align: center;
        }

        .guide-title {
            font-size: 28px;
            color: #e67e22;
            margin-bottom: 20px;
        }

        .guide-item {
            margin: 15px 0;
            text-align: left;
            font-size: 16px;
        }

        /* é¦–é¡µ */
        #game-home {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px 20px;
            border-radius: 24px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            border: 3px solid #f39c12;
            text-align: center;
        }

        .home-title {
            font-size: 36px;
            color: #e67e22;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .year-theme {
            color: #d35400;
            font-size: 20px;
            margin-bottom: 20px;
        }

        /* é€‰é¡¹ç»„ */
        .option-group {
            margin: 15px 0;
            width: 100%;
        }

        .option-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        /* çš®è‚¤é€‰æ‹© */
        .skin-options {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }

        .skin-btn {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            border: 3px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .skin-btn.active {
            border-color: #e67e22;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(230, 126, 34, 0.3);
        }

        /* éš¾åº¦/æ“æ§é€‰æ‹© */
        .mode-options {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 8px 18px;
            font-size: 16px;
            margin: 5px;
            border-radius: 50px;
            border: 2px solid #eee;
            background: white;
            color: #333;
            cursor: pointer;
        }

        .mode-btn.active {
            background: #e67e22;
            color: white;
            border-color: #e67e22;
        }

        /* æ¸¸æˆä¸»å®¹å™¨ */
        #game-container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* æ¸¸æˆå¤´éƒ¨ */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 10px;
        }

        .game-title-small {
            font-size: 24px;
            color: #e67e22;
        }

        .score-panel {
            display: flex;
            gap: 10px;
        }

        .score {
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 50px;
            color: #2c3e50;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Canvaså®¹å™¨ - å¼ºåˆ¶æ­£æ–¹å½¢ */
        #canvas-wrapper {
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1/1;
            position: relative;
            background: #fff;
            border-radius: 24px;
            padding: 10px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            border: 3px solid #f39c12;
        }

        /* Canvas - åŒ¹é…å®¹å™¨å°ºå¯¸ */
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff8e6;
            border-radius: 16px;
            display: block !important;
            object-fit: contain;
        }

        /* æš‚åœ/ç»“æŸé¢æ¿ */
        .overlay-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            z-index: 10;
        }

        .panel-title {
            font-size: 28px;
            color: #e67e22;
        }

        /* åœ†ç›˜æ“æ§ - ä¼˜åŒ–æ ·å¼ */
        #joystick-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            border: 2px solid #f39c12;
            display: none;
            z-index: 5;
        }

        .joystick-bg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #fff8e6 0%, #ffe0b2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .joystick-knob {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            box-shadow: 0 4px 10px rgba(230, 126, 34, 0.3);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            touch-action: none;
            transition: transform 0.05s ease; /* ä¼˜åŒ–æ»‘åŠ¨åé¦ˆ */
        }

        /* æ’è¡Œæ¦œå¼¹çª— */
        #rank-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            padding: 30px 20px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 90%;
            max-width: 380px;
            z-index: 1000;
            border: 3px solid #f39c12;
        }

        .rank-list {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 16px;
        }

        .rank-num {
            color: #e67e22;
            font-weight: bold;
            width: 30px;
        }

        .rank-score {
            color: #2c3e50;
            font-weight: bold;
        }

        .rank-date {
            color: #7f8c8d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- éŸ³æ•ˆ/éŸ³ä¹æ§åˆ¶ -->
    <div class="audio-controls">
        <div class="audio-btn" id="music-btn" title="èƒŒæ™¯éŸ³ä¹">ğŸµ</div>
        <div class="audio-btn" id="sound-btn" title="æ¸¸æˆéŸ³æ•ˆ">ğŸ”Š</div>
    </div>

    <!-- æ¸¸æˆå¼•å¯¼é¡µ -->
    <div id="guide-page">
        <div class="guide-content">
            <h2 class="guide-title">ğŸ æ¸¸æˆç©æ³•æŒ‡å—</h2>
            
            <div class="guide-item">
                <strong>ğŸ® æ“æ§æ–¹å¼ï¼š</strong><br>
                â€¢ é”®ç›˜ï¼šæ–¹å‘é”®æ§åˆ¶è›‡çš„ç§»åŠ¨<br>
                â€¢ åœ†ç›˜ï¼šæ»‘åŠ¨åœ†ç›˜æ§åˆ¶æ–¹å‘
            </div>
            
            <div class="guide-item">
                <strong>ğŸ å¾—åˆ†è§„åˆ™ï¼š</strong><br>
                â€¢ åƒåˆ°è‹¹æœ+1åˆ†<br>
                â€¢ è›‡è¶Šé•¿ï¼Œéš¾åº¦è¶Šé«˜
            </div>
            
            <div class="guide-item">
                <strong>âš ï¸ æ¸¸æˆç»“æŸï¼š</strong><br>
                â€¢ æ’åˆ°å¢™å£æˆ–è‡ªå·±èº«ä½“
            </div>
            
            <div class="guide-item">
                <strong>ğŸ¨ çš®è‚¤æ›´æ¢ï¼š</strong><br>
                â€¢ é€‰æ‹©ä¸åŒçš®è‚¤ï¼Œè›‡çš„å¤–è§‚ä¼šå˜åŒ–
            </div>
            
            <div class="guide-item">
                <strong>ğŸ† æ’è¡Œæ¦œï¼š</strong><br>
                â€¢ è‡ªåŠ¨è®°å½•ä½ çš„æœ€é«˜åˆ†æ•°
            </div>
            
            <button class="btn btn-primary" onclick="closeGuide()">å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>

    <!-- é¦–é¡µ -->
    <div id="game-home">
        <h1 class="home-title">æˆ‘æ˜¯è´ªåƒè›‡ ğŸ</h1>
        <div class="year-theme">ğŸ´ 2026é©¬å¹´æ–°æ˜¥ç‰ˆ ğŸ§§</div>

        <!-- æ“æ§æ–¹å¼ -->
        <div class="option-group">
            <div class="option-title">ğŸ® æ“æ§æ–¹å¼</div>
            <div class="mode-options">
                <button class="mode-btn active" data-control="keyboard">é”®ç›˜æ“æ§</button>
                <button class="mode-btn" data-control="joystick">åœ†ç›˜æ“æ§</button>
            </div>
        </div>

        <!-- éš¾åº¦é€‰æ‹© -->
        <div class="option-group">
            <div class="option-title">ğŸ¢ æ¸¸æˆéš¾åº¦</div>
            <div class="mode-options">
                <button class="mode-btn active" data-speed="200">ç®€å•</button>
                <button class="mode-btn" data-speed="150">ä¸­ç­‰</button>
                <button class="mode-btn" data-speed="120">å›°éš¾</button>
            </div>
        </div>

        <!-- çš®è‚¤é€‰æ‹© -->
        <div class="option-group">
            <div class="option-title">ğŸ¨ è›‡è›‡çš®è‚¤</div>
            <div class="skin-options">
                <div class="skin-btn active" data-skin="year" title="é©¬å¹´ä¸»é¢˜">ğŸ´</div>
                <div class="skin-btn" data-skin="red" title="ä¸­å›½çº¢">ğŸ”´</div>
                <div class="skin-btn" data-skin="gold" title="é»„é‡‘">ğŸŸ¡</div>
                <div class="skin-btn" data-skin="green" title="ç¿¡ç¿ ">ğŸŸ¢</div>
                <div class="skin-btn" data-skin="blue" title="å®çŸ³">ğŸ”µ</div>
            </div>
        </div>

        <!-- åŠŸèƒ½æŒ‰é’® -->
        <button class="btn btn-primary" id="start-btn">å¼€å§‹æ¸¸æˆ ğŸ®</button>
        <button class="btn btn-secondary" onclick="showRank()">æŸ¥çœ‹æ’è¡Œæ¦œ ğŸ†</button>
    </div>

    <!-- æ¸¸æˆä¸»å®¹å™¨ -->
    <div id="game-container" style="display: none;">
        <div class="game-header">
            <div class="game-title-small">æˆ‘æ˜¯è´ªåƒè›‡ ğŸ</div>
            <div class="score-panel">
                <div class="score">åˆ†æ•°ï¼š<span id="score">0</span></div>
                <div class="score">æœ€é«˜åˆ†ï¼š<span id="highest">0</span></div>
            </div>
        </div>

        <div id="canvas-wrapper">
            <canvas id="game-canvas"></canvas>

            <!-- æš‚åœé¢æ¿ -->
            <div class="overlay-panel" id="pause-panel">
                <h2 class="panel-title">æ¸¸æˆæš‚åœ â¸ï¸</h2>
                <button class="btn btn-primary" onclick="togglePause()">ç»§ç»­æ¸¸æˆ</button>
                <button class="btn btn-secondary" onclick="backToHome()">è¿”å›é¦–é¡µ</button>
            </div>

            <!-- ç»“æŸé¢æ¿ -->
            <div class="overlay-panel" id="over-panel">
                <h2 class="panel-title">æ¸¸æˆç»“æŸ ğŸ˜¢</h2>
                <div style="font-size: 20px;">æœ€ç»ˆåˆ†æ•°ï¼š<span id="final-score">0</span></div>
                <button class="btn btn-primary" onclick="restartGame()">å†æ¥ä¸€æ¬¡ ğŸ®</button>
                <button class="btn btn-secondary" onclick="backToHome()">è¿”å›é¦–é¡µ ğŸ </button>
                <button class="btn btn-success" onclick="showRank()">æŸ¥çœ‹æ’è¡Œæ¦œ ğŸ†</button>
            </div>
        </div>

        <!-- åœ†ç›˜æ“æ§ - ç¡®ä¿å­˜åœ¨ -->
        <div id="joystick-panel">
            <div class="joystick-bg">
                <div class="joystick-knob" id="joystick"></div>
            </div>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œå¼¹çª— -->
    <div id="rank-modal">
        <h2 class="panel-title">ğŸ† æ¸¸æˆæ’è¡Œæ¦œ</h2>
        <div class="rank-list" id="rank-list">
            <!-- æ’è¡Œæ¦œå†…å®¹åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <button class="btn btn-secondary" onclick="closeRank()">å…³é—­</button>
    </div>

    <!-- éŸ³é¢‘èµ„æº -->
    <audio id="bg-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-joyful-festival-1369.mp3" type="audio/mpeg">
    
    <audio id="eat-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" type="audio/mpeg">
    
    <audio id="hit-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3" type="audio/mpeg">
    

    <script>
        // ========== æ ¸å¿ƒé…ç½® ==========
        const config = {
            control: "keyboard",
            speed: 200,
            skin: "year",
            gridSize: 20,
            musicOn: true,
            soundOn: true,
            joystickDeadZone: 5 // ä¼˜åŒ–ï¼šå‡å°æ­»åŒºï¼Œæå‡çµæ•åº¦
        };

        // çš®è‚¤ä¸»é¢˜
        const skins = {
            year: { head: "#e67e22", body: "#f39c12", eye: "#fff", bg: "#fff8e6" },
            red: { head: "#e74c3c", body: "#c0392b", eye: "#fff", bg: "#ffebee" },
            gold: { head: "#f1c40f", body: "#f39c12", eye: "#000", bg: "#fff9c4" },
            green: { head: "#2ecc71", body: "#27ae60", eye: "#fff", bg: "#e8f5e9" },
            blue: { head: "#3498db", body: "#2980b9", eye: "#fff", bg: "#e3f2fd" }
        };

        // æ¸¸æˆæ ¸å¿ƒå˜é‡
        let canvas, ctx;
        let snake = [];
        let food = {};
        let dx = 0;
        let dy = -1;
        let score = 0;
        let highest = 0;
        let gameLoop = null;
        let isPaused = false;
        let rankData = [];

        // DOMå…ƒç´ ç¼“å­˜
        const dom = {
            gameHome: document.getElementById("game-home"),
            gameContainer: document.getElementById("game-container"),
            canvas: document.getElementById("game-canvas"),
            joystickPanel: document.getElementById("joystick-panel"),
            audio: {
                bgMusic: document.getElementById("bg-music"),
                eatSound: document.getElementById("eat-sound"),
                hitSound: document.getElementById("hit-sound")
            }
        };

        // ========== åˆå§‹åŒ– ==========
        window.onload = function() {
            initCanvas();
            loadHighestScore();
            loadRankData();
            bindAllEvents();
            playBgMusic();
            initGameData();
            drawGame();
        };

        // ========== Canvasåˆå§‹åŒ– ==========
        function initCanvas() {
            canvas = dom.canvas;
            ctx = canvas.getContext("2d");
            resizeCanvas();
            window.addEventListener("resize", resizeCanvas);
        }

        function resizeCanvas() {
            const wrapper = document.getElementById("canvas-wrapper");
            const size = wrapper.clientWidth;
            canvas.width = size;
            canvas.height = size;
            if (snake.length > 0) drawGame();
        }

        // ========== äº‹ä»¶ç»‘å®š ==========
        function bindAllEvents() {
            document.getElementById("guide-page").style.display = "flex";
            
            // éŸ³æ•ˆ/éŸ³ä¹å¼€å…³
            document.getElementById("music-btn").addEventListener("click", toggleMusic);
            document.getElementById("sound-btn").addEventListener("click", toggleSound);
            
            // æ“æ§æ–¹å¼é€‰æ‹©
            document.querySelectorAll(".mode-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const siblings = Array.from(btn.parentElement.children);
                    siblings.forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    
                    if (btn.dataset.control) config.control = btn.dataset.control;
                    if (btn.dataset.speed) config.speed = parseInt(btn.dataset.speed);
                });
            });
            
            // çš®è‚¤é€‰æ‹©
            document.querySelectorAll(".skin-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    document.querySelectorAll(".skin-btn").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    config.skin = btn.dataset.skin;
                    drawGame();
                });
            });
            
            // å¼€å§‹æ¸¸æˆæŒ‰é’®
            document.getElementById("start-btn").addEventListener("click", startGame);
            
            // é”®ç›˜æ§åˆ¶
            document.addEventListener("keydown", handleKeydown);
        }

        // ========== æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ==========
        function initGameData() {
            const mid = Math.floor(config.gridSize / 2);
            snake = [
                { x: mid, y: mid },
                { x: mid, y: mid + 1 },
                { x: mid, y: mid + 2 }
            ];
            dx = 0;
            dy = -1;
            generateFood();
            score = 0;
            document.getElementById("score").innerText = "0";
        }

        function startGame() {
            dom.gameHome.style.display = "none";
            dom.gameContainer.style.display = "flex";
            resizeCanvas();
            
            // æ˜¾ç¤ºåœ†ç›˜æ“æ§
            if (config.control === "joystick") {
                dom.joystickPanel.style.display = "block";
                initJoystick(); // åˆå§‹åŒ–åœ†ç›˜
            } else {
                dom.joystickPanel.style.display = "none";
            }
            
            initGameData();
            clearInterval(gameLoop);
            gameLoop = setInterval(updateGame, config.speed);
            drawGame();
        }

        function updateGame() {
            if (isPaused) return;
            
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            
            if (head.x < 0 || head.x >= config.gridSize || head.y < 0 || head.y >= config.gridSize) {
                gameOver();
                return;
            }
            
            if (snake.some(s => s.x === head.x && s.y === head.y)) {
                gameOver();
                return;
            }
            
            snake.unshift(head);
            
            if (head.x === food.x && head.y === food.y) {
                score++;
                document.getElementById("score").innerText = score;
                playSound("eatSound");
                generateFood();
            } else {
                snake.pop();
            }
            
            drawGame();
        }

        function drawGame() {
            const cellSize = canvas.width / config.gridSize;
            const skin = skins[config.skin];
            
            ctx.fillStyle = skin.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = "rgba(0,0,0,0.05)";
            ctx.lineWidth = 1;
            for (let i = 0; i <= config.gridSize; i++) {
                ctx.beginPath();
                ctx.moveTo(i * cellSize, 0);
                ctx.lineTo(i * cellSize, canvas.height);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, i * cellSize);
                ctx.lineTo(canvas.width, i * cellSize);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶è›‡
            snake.forEach((seg, index) => {
                const x = seg.x * cellSize;
                const y = seg.y * cellSize;
                
                if (index === 0) {
                    ctx.fillStyle = skin.head;
                    ctx.beginPath();
                    ctx.roundRect(x + 2, y + 2, cellSize - 4, cellSize - 4, 12);
                    ctx.fill();
                    
                    // çœ¼ç›
                    ctx.fillStyle = skin.eye;
                    const eyeSize = cellSize / 6;
                    let eye1X = x + cellSize * 0.3;
                    let eye1Y = y + cellSize * 0.4;
                    let eye2X = x + cellSize * 0.7;
                    let eye2Y = y + cellSize * 0.4;
                    
                    ctx.beginPath();
                    ctx.arc(eye1X, eye1Y, eyeSize, 0, Math.PI * 2);
                    ctx.arc(eye2X, eye2Y, eyeSize, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.fillStyle = skin.body;
                    ctx.beginPath();
                    ctx.roundRect(x + 3, y + 3, cellSize - 6, cellSize - 6, 10);
                    ctx.fill();
                }
            });
            
            // ç»˜åˆ¶é£Ÿç‰©
            ctx.fillStyle = "#e74c3c";
            ctx.beginPath();
            ctx.roundRect(
                food.x * cellSize + 4,
                food.y * cellSize + 4,
                cellSize - 8,
                cellSize - 8,
                10
            );
            ctx.fill();
            
            ctx.fillStyle = "#fff";
            ctx.font = (cellSize * 0.6) + "px Arial";
            ctx.textAlign = "center";
            ctx.fillText("ğŸ", food.x * cellSize + cellSize/2, food.y * cellSize + cellSize/2 + cellSize/6);
        }

        // ========== åœ†ç›˜æ“æ§ - ä¼˜åŒ–çµæ•åº¦ ==========
        function initJoystick() {
            const joystick = document.getElementById("joystick");
            let isDragging = false;
            const joystickPanel = dom.joystickPanel;
            
            joystick.addEventListener("mousedown", startDrag);
            joystick.addEventListener("touchstart", (e) => {
                e.preventDefault();
                startDrag(e.touches[0]);
            });
            
            document.addEventListener("mousemove", drag);
            document.addEventListener("touchmove", (e) => {
                e.preventDefault();
                drag(e.touches[0]);
            });
            
            document.addEventListener("mouseup", endDrag);
            document.addEventListener("touchend", endDrag);
            
            function startDrag(e) {
                isDragging = true;
            }
            
            function drag(e) {
                if (!isDragging || isPaused) return;
                
                const rect = joystickPanel.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                const touchX = e.clientX || e.pageX;
                const touchY = e.clientY || e.pageY;
                
                const deltaX = touchX - centerX;
                const deltaY = touchY - centerY;
                
                // ä¼˜åŒ–ï¼šå‡å°æ­»åŒºï¼Œæå‡çµæ•åº¦
                if (Math.abs(deltaX) > config.joystickDeadZone || Math.abs(deltaY) > config.joystickDeadZone) {
                    if (Math.abs(deltaX) > Math.abs(deltaY)) {
                        dx = deltaX > 0 ? 1 : -1;
                        dy = 0;
                    } else {
                        dy = deltaY > 0 ? 1 : -1;
                        dx = 0;
                    }
                }
                
                // ä¼˜åŒ–ï¼šæ›´æµç•…çš„åœ†ç›˜ç§»åŠ¨
                const maxDist = 30;
                const dist = Math.min(Math.sqrt(deltaX*deltaX + deltaY*deltaY), maxDist);
                const radian = Math.atan2(deltaY, deltaX);
                
                const knobX = Math.cos(radian) * dist;
                const knobY = Math.sin(radian) * dist;
                
                joystick.style.transform = `translate(${knobX - 25}px, ${knobY - 25}px)`;
            }
            
            function endDrag() {
                isDragging = false;
                joystick.style.transform = "translate(-50%, -50%)";
            }
        }

        // ========== å…¶ä»–è¾…åŠ©å‡½æ•° ==========
        function generateFood() {
            food = {
                x: Math.floor(Math.random() * config.gridSize),
                y: Math.floor(Math.random() * config.gridSize)
            };
            
            if (snake.some(s => s.x === food.x && s.y === food.y)) {
                generateFood();
            }
        }

        function handleKeydown(e) {
            if (isPaused) return;
            
            switch (e.key) {
                case "ArrowUp": if (dy !== 1) { dx = 0; dy = -1; } break;
                case "ArrowDown": if (dy !== -1) { dx = 0; dy = 1; } break;
                case "ArrowLeft": if (dx !== 1) { dx = -1; dy = 0; } break;
                case "ArrowRight": if (dx !== -1) { dx = 1; dy = 0; } break;
                case " ": togglePause(); break;
            }
        }

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById("pause-panel").style.display = isPaused ? "flex" : "none";
        }

        function gameOver() {
            clearInterval(gameLoop);
            playSound("hitSound");
            
            document.getElementById("final-score").innerText = score;
            saveHighestScore();
            saveToRank();
            
            document.getElementById("over-panel").style.display = "flex";
        }

        function restartGame() {
            document.getElementById("over-panel").style.display = "none";
            initGameData();
            gameLoop = setInterval(updateGame, config.speed);
            isPaused = false;
        }

        function backToHome() {
            clearInterval(gameLoop);
            dom.gameContainer.style.display = "none";
            dom.gameHome.style.display = "flex";
            isPaused = false;
        }

        function playSound(soundName) {
            if (!config.soundOn) return;
            const sound = dom.audio[soundName];
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥:", e));
            }
        }

        function playBgMusic() {
            if (config.musicOn) {
                dom.audio.bgMusic.volume = 0.3;
                dom.audio.bgMusic.play().catch(e => console.log("èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥:", e));
            }
        }

        function toggleMusic() {
            config.musicOn = !config.musicOn;
            const btn = document.getElementById("music-btn");
            btn.innerHTML = config.musicOn ? "ğŸµ" : "ğŸ”‡";
            
            if (config.musicOn) dom.audio.bgMusic.play();
            else dom.audio.bgMusic.pause();
        }

        function toggleSound() {
            config.soundOn = !config.soundOn;
            const btn = document.getElementById("sound-btn");
            btn.innerHTML = config.soundOn ? "ğŸ”Š" : "ğŸ”‡";
        }

        function loadHighestScore() {
            highest = localStorage.getItem("snakeHighest") || 0;
            document.getElementById("highest").innerText = highest;
        }

        function saveHighestScore() {
            if (score > highest) {
                highest = score;
                localStorage.setItem("snakeHighest", highest);
                document.getElementById("highest").innerText = highest;
            }
        }

        function loadRankData() {
            const rankStr = localStorage.getItem("snakeRank");
            rankData = rankStr ? JSON.parse(rankStr) : [];
            rankData.sort((a, b) => b.score - a.score);
            if (rankData.length > 10) rankData = rankData.slice(0, 10);
        }

        function saveToRank() {
            if (score <= 0) return;
            
            const now = new Date();
            const record = {
                score: score,
                date: `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`
            };
            
            rankData.push(record);
            rankData.sort((a, b) => b.score - a.score);
            if (rankData.length > 10) rankData = rankData.slice(0, 10);
            
            localStorage.setItem("snakeRank", JSON.stringify(rankData));
        }

        function showRank() {
            loadRankData();
            const rankList = document.getElementById("rank-list");
            rankList.innerHTML = "";
            
            if (rankData.length === 0) {
                rankList.innerHTML = '<div class="rank-item" style="justify-content:center;">æš‚æ— è®°å½•</div>';
            } else {
                rankData.forEach((item, index) => {
                    const rankItem = document.createElement("div");
                    rankItem.className = "rank-item";
                    
                    let rankNum = index + 1;
                    if (rankNum === 1) rankNum = "ğŸ¥‡";
                    else if (rankNum === 2) rankNum = "ğŸ¥ˆ";
                    else if (rankNum === 3) rankNum = "ğŸ¥‰";
                    
                    rankItem.innerHTML = `
                        <span class="rank-num">${rankNum}</span>
                        <span class="rank-score">${item.score} åˆ†</span>
                        <span class="rank-date">${item.date}</span>
                    `;
                    
                    rankList.appendChild(rankItem);
                });
            }
            
            document.getElementById("rank-modal").style.display = "flex";
        }

        function closeRank() {
            document.getElementById("rank-modal").style.display = "none";
        }

        function closeGuide() {
            document.getElementById("guide-page").style.display = "none";
        }
    </script>
</body>
</html>
