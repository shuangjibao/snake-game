<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æˆ‘æ˜¯è´ªåƒè›‡ ğŸ 2026é©¬å¹´æ–°æ˜¥é™å®šç‰ˆ</title>
    <style>
        :root { 
            --gold: #f39c12; 
            --red: #e74c3c; 
            --bg: #fff8e6; 
            --orange: #e67e22;
        }
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        body { 
            background: radial-gradient(circle, #fff8e6 0%, #ffe0b2 100%);
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
            touch-action: pan-y;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }
        /* ä¾§è¾¹æ»‘åŠ¨æ¡ç¾åŒ– */
        body::-webkit-scrollbar {
            width: 8px;
        }
        body::-webkit-scrollbar-track {
            background: rgba(255,248,230,0.5);
        }
        body::-webkit-scrollbar-thumb {
            background: var(--gold);
            border-radius: 4px;
        }
        body::-webkit-scrollbar-thumb:hover {
            background: var(--orange);
        }
        /* AI å¼€å…³æŒ‰é’® */
        #ai-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.9);
            border: 2px solid var(--gold);
            color: var(--gold);
            font-size: 20px;
            cursor: pointer;
            z-index: 99;
        }
        #ai-toggle.ai-on {
            background: var(--red);
            color: white;
            border-color: var(--red);
        }
        /* éŸ³æ•ˆ/éŸ³ä¹å¼€å…³ */
        .audio-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 99;
        }
        .audio-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.9);
            border: 2px solid var(--gold);
            color: var(--gold);
            font-size: 20px;
            cursor: pointer;
        }
        /* æ¸¸æˆå¼•å¯¼é¡µ */
        #guide-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
            padding: 20px;
        }
        .guide-content {
            background: rgba(255,255,255,0.95);
            border-radius: 24px;
            padding: 30px;
            max-width: 400px;
            color: #333;
            text-align: center;
            position: relative;
            z-index: 1001;
        }
        .guide-title {
            font-size: 28px;
            color: var(--orange);
            margin-bottom: 20px;
        }
        .guide-item {
            margin: 15px 0;
            text-align: left;
            font-size: 16px;
        }
        /* é¦–é¡µ */
        #game-home {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 95%;
            max-width: 420px;
            background: white;
            padding: 30px 20px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(211, 84, 0, 0.2);
            border: 4px solid var(--gold);
            text-align: center;
            margin: 20px auto;
        }
        .home-title {
            font-size: 36px;
            color: var(--orange);
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .year-theme {
            color: var(--red);
            font-size: 20px;
            margin-bottom: 20px;
        }
        /* é€‰é¡¹ç»„ */
        .option-group {
            margin: 15px 0;
            width: 100%;
        }
        .option-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        /* éš¾åº¦/æ“æ§é€‰æ‹© - ä¿®å¤ä¸ºå›¾2æ ·å¼ */
        .mode-options {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .mode-btn {
            padding: 8px 18px;
            font-size: 16px;
            margin: 0;
            border-radius: 50px;
            border: 2px solid #eee;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        /* é€‰ä¸­çŠ¶æ€ - å›¾2æ©™è‰²æ ·å¼ */
        .mode-btn.active {
            background: var(--orange);
            color: white;
            border-color: var(--orange);
            box-shadow: 0 4px 8px rgba(230, 126, 34, 0.2);
        }
        /* çš®è‚¤é€‰æ‹© */
        .skin-options {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .skin-btn {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            border: 3px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            overflow: hidden;
            position: relative;
        }
        .skin-btn.active {
            border-color: var(--orange);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(230, 126, 34, 0.3);
        }
        /* è‡ªå®šä¹‰çš®è‚¤æŒ‰é’®æ ·å¼ */
        .custom-skin-btn {
            flex-direction: column;
            font-size: 14px;
            padding: 5px;
        }
        .custom-skin-btn input {
            display: none;
        }
        .custom-skin-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        /* è‡ªå®šä¹‰çš®è‚¤å¼¹çª— - é€‚é…ä¸‰ä¸ªéƒ¨åˆ† */
        #custom-skin-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border: 3px solid var(--gold);
            z-index: 1001;
            display: none;
            width: 90%;
            max-width: 450px; /* åŠ å®½é€‚é…ä¸‰ä¸ªé¢„è§ˆ */
        }
        .modal-title {
            font-size: 22px;
            color: var(--orange);
            margin-bottom: 20px;
            text-align: center;
        }
        .skin-upload-group {
            margin: 15px 0;
        }
        .upload-label {
            display: block;
            padding: 10px;
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        .upload-label:hover {
            background: #f0f0f0;
            border-color: var(--gold);
        }
        .upload-tip {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }
        /* é¢„è§ˆå®¹å™¨ - æ”¹ä¸ºæ¨ªå‘ä¸‰åˆ— */
        .preview-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .preview-item {
            text-align: center;
            flex: 1;
            min-width: 80px;
            max-width: 100px;
        }
        .preview-box {
            width: 80px;
            height: 80px;
            border: 2px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 5px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            display: block;
        }
        .modal-btn-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        /* é¡¶éƒ¨ä¿¡æ¯æ ï¼ˆä¿®å¤é‡å ï¼‰ */
        .header { 
            width: 95%; 
            max-width: 420px; 
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between; 
            padding: 15px 5px; 
            margin: 0 auto;
            position: relative;
            gap: 10px;
        }
        .stat-box { 
            background: white; 
            padding: 5px 15px; 
            border-radius: 50px; 
            border: 2px solid var(--gold); 
            font-weight: bold; 
            flex-shrink: 0;
        }
        /* æ¸¸æˆæ§åˆ¶æŒ‰é’®ï¼ˆä¿®å¤é‡å ï¼‰ */
        .game-controls {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        .game-controls .btn {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        /* è¿å‡»æç¤ºç‰¹æ•ˆ */
        #combo-tip {
            position: absolute; 
            top: 40%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            color: var(--red); 
            font-size: 40px; 
            font-weight: 900; 
            pointer-events: none;
            opacity: 0; 
            transition: all 0.3s; 
            text-shadow: 2px 2px 0 white; 
            z-index: 100;
        }
        /* æ¸¸æˆå®¹å™¨ä¸é˜´å½± */
        #game-wrapper {
            width: 95%; 
            max-width: 420px; 
            position: relative; 
            margin: 10px auto;
            background: white; 
            padding: 10px; 
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(211, 84, 0, 0.2); 
            border: 4px solid var(--gold);
            display: none;
        }
        canvas { 
            width: 100%; 
            display: block; 
            border-radius: 12px; 
            background: #fffcf5; 
        }
        /* æ€»ç»“é¢æ¿ä¼˜åŒ– */
        .overlay {
            position: absolute; 
            inset: 0; 
            background: rgba(255,255,255,0.95);
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            z-index: 200; 
            border-radius: 16px; 
            padding: 20px; 
            text-align: center;
            overflow-y: auto;
        }
        .overlay::-webkit-scrollbar {
            width: 6px;
        }
        .overlay::-webkit-scrollbar-track {
            background: rgba(255,248,230,0.5);
        }
        .overlay::-webkit-scrollbar-thumb {
            background: var(--gold);
            border-radius: 3px;
        }
        .share-card { 
            background: white; 
            border: 2px dashed var(--gold); 
            padding: 15px; 
            border-radius: 15px; 
            margin-bottom: 15px; 
        }
        .route-summary-container { 
            width: 240px; 
            height: 160px; 
            background: #fef9ef; 
            border: 1px solid #ddd; 
            margin: 10px auto; 
        }
        /* æŒ‰é’®è®¾è®¡ */
        .btn-group { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
            justify-content: center; 
        }
        .btn {
            padding: 10px 20px; 
            border-radius: 50px; 
            border: none; 
            font-weight: bold;
            cursor: pointer; 
            transition: transform 0.1s; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            margin: 8px;
        }
        .btn-main { 
            background: var(--red); 
            color: white; 
        }
        .btn-sub { 
            background: var(--gold); 
            color: white; 
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--orange) 0%, #d35400 100%);
            color: white;
            padding: 12px 25px;
            font-size: 18px;
        }
        .btn:active { 
            transform: translateY(2px); 
            box-shadow: none; 
        }
        /* æš‚åœé¢æ¿ */
        #pause-panel {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            border-radius: 16px;
            padding: 20px;
        }
        .panel-title {
            font-size: 28px;
            color: var(--orange);
            margin-bottom: 20px;
        }
        /* è·Ÿéšæ‰‹æŒ‡çš„æ‘‡æ†æ ·å¼ */
        #joystick-area {
            margin: 20px auto; 
            width: 140px; 
            height: 140px; 
            background: radial-gradient(circle at center, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.6) 70%, rgba(243, 156, 18, 0.2) 100%);
            border-radius: 50%; 
            position: relative; 
            border: 2px solid rgba(243, 156, 18, 0.3);
            display: none;
            touch-action: none; 
            z-index: 50;
            -webkit-user-select: none;
            user-select: none;
            cursor: pointer;
        }
        #knob {
            width: 55px; 
            height: 55px; 
            background: var(--gold); 
            border-radius: 50%;
            position: absolute; 
            left: 42.5px; 
            top: 42.5px; 
            box-shadow: 0 0 0 4px rgba(243, 156, 18, 0.3), 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.05s ease-out;
            touch-action: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            border: 3px solid rgba(255, 255, 255, 0.8);
        }
        /* æ’è¡Œæ¦œå¼¹çª— */
        #rank-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            padding: 30px 20px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 90%;
            max-width: 380px;
            z-index: 1001;
            border: 3px solid var(--gold);
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .rank-list {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
        }
        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 16px;
        }
        .rank-num {
            color: var(--orange);
            font-weight: bold;
            width: 30px;
        }
        .rank-score {
            color: #2c3e50;
            font-weight: bold;
        }
        .rank-date {
            color: #7f8c8d;
            font-size: 14px;
        }
        /* é®ç½©å±‚ */
        #mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        /* åŠ è½½æç¤ºæ ·å¼ */
        #upload-tip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 8px;
            font-size: 16px;
            z-index: 9999;
            display: none;
        }
        /* ç”µè„‘ç«¯ä¼˜åŒ– */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            #game-home, #game-wrapper {
                max-width: 500px;
            }
            .header {
                max-width: 500px;
            }
        }
        /* æ‰‹æœºç«¯ä¼˜åŒ– */
        @media (max-width: 767px) {
            #ai-toggle {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            .audio-controls {
                top: 10px;
                right: 10px;
            }
            .audio-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            #game-home, #game-wrapper {
                width: 100%;
                margin: 10px auto;
            }
            .home-title {
                font-size: 30px;
            }
            .preview-container {
                flex-direction: row;
                gap: 10px;
            }
            .preview-item {
                min-width: 70px;
                max-width: 80px;
            }
            .preview-box {
                width: 70px;
                height: 70px;
            }
            .header {
                justify-content: center;
            }
            .stat-box {
                font-size: 14px;
                padding: 5px 10px;
            }
            /* ç§»åŠ¨ç«¯æ‘‡æ†ä¼˜åŒ– */
            #joystick-area {
                width: 120px;
                height: 120px;
            }
            #knob {
                width: 50px;
                height: 50px;
                left: 35px;
                top: 35px;
            }
        }
    </style>
</head>
<body>
    <!-- é®ç½©å±‚ -->
    <div id="mask"></div>
    <!-- AI å¼€å…³ -->
    <div id="ai-toggle" title="AI æœ€çŸ­è·¯å¾„è§„åˆ’">ğŸ§ </div>
    <!-- éŸ³æ•ˆ/éŸ³ä¹æ§åˆ¶ -->
    <div class="audio-controls">
        <div class="audio-btn" id="music-btn" title="èƒŒæ™¯éŸ³ä¹">ğŸµ</div>
        <div class="audio-btn" id="sound-btn" title="æ¸¸æˆéŸ³æ•ˆ">ğŸ”Š</div>
    </div>
    <!-- æ¸¸æˆå¼•å¯¼é¡µ -->
    <div id="guide-page">
        <div class="guide-content">
            <h2 class="guide-title">ğŸ 2026é©¬å¹´æ–°æ˜¥è´ªåƒè›‡</h2>
            
            <div class="guide-item">
                <strong>ğŸ® æ“æ§æ–¹å¼ï¼š</strong><br>
                â€¢ ç”µè„‘ï¼šæ–¹å‘é”®æ§åˆ¶è›‡çš„ç§»åŠ¨ï¼›åœ†ç›˜æ¨¡å¼å¯é¼ æ ‡æ‹–åŠ¨æ“æ§<br>
                â€¢ æ‰‹æœºï¼šæ‘‡æ†å®Œå…¨è·Ÿéšæ‰‹æŒ‡ç§»åŠ¨ï¼Œ360Â°è‡ªç”±æ§åˆ¶
            </div>
            
            <div class="guide-item">
                <strong>ğŸ§  AI æœ€çŸ­è·¯å¾„ï¼š</strong><br>
                â€¢ ç‚¹å‡»å·¦ä¸Šè§’ ğŸ§  å¼€å¯/å…³é—­ AI è‡ªåŠ¨å¯»è·¯<br>
                â€¢ AI ä¼šè‡ªåŠ¨è§„åˆ’æœ€çŸ­è·¯å¾„å»åƒè‹¹æœ
            </div>
            
            <div class="guide-item">
                <strong>ğŸ å¾—åˆ†è§„åˆ™ï¼š</strong><br>
                â€¢ åƒåˆ°è‹¹æœ+10åˆ†ï¼Œè¿å‡»åˆ†æ•°ç¿»å€<br>
                â€¢ è›‡è¶Šé•¿ï¼Œéš¾åº¦è¶Šé«˜
            </div>
            
            <div class="guide-item">
                <strong>âš ï¸ æ¸¸æˆç»“æŸï¼š</strong><br>
                â€¢ æ’åˆ°å¢™å£æˆ–è‡ªå·±èº«ä½“
            </div>
            
            <div class="guide-item">
                <strong>ğŸ¨ çš®è‚¤æ›´æ¢ï¼š</strong><br>
                â€¢ æ”¯æŒé¢„è®¾çš®è‚¤å’Œè‡ªå®šä¹‰ä¸Šä¼ å›¾ç‰‡ä½œä¸ºè›‡å¤´ã€è›‡èº«ã€è›‡å°¾çš®è‚¤<br>
                â€¢ è‡ªå®šä¹‰çš®è‚¤ä¼šåº”ç”¨åˆ°æ¸¸æˆè¿‡ç¨‹ä¸­çš„æ¯ä¸€èŠ‚èº«ä½“
            </div>
            
            <div class="guide-item">
                <strong>ğŸ† æ’è¡Œæ¦œï¼š</strong><br>
                â€¢ è‡ªåŠ¨è®°å½•ä½ çš„æœ€é«˜åˆ†æ•°
            </div>
            
            <div class="guide-item">
                <strong>ğŸ“Š æˆ˜æŠ¥æ€»ç»“ï¼š</strong><br>
                â€¢ æ¸¸æˆç»“æŸåå¯æŸ¥çœ‹æ–°æ˜¥æˆ˜æŠ¥å’Œè·¯çº¿è½¨è¿¹
            </div>
            
            <button class="btn btn-primary" onclick="closeGuide()">å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>
    <!-- è‡ªå®šä¹‰çš®è‚¤å¼¹çª— - å‡çº§ä¸ºè›‡å¤´/è›‡èº«/è›‡å°¾ -->
    <div id="custom-skin-modal">
        <h3 class="modal-title">ğŸ¨ è‡ªå®šä¹‰è›‡çš®è‚¤</h3>
        <!-- è›‡å¤´ä¸Šä¼  -->
        <div class="skin-upload-group">
            <label class="upload-label" for="head-upload">
                ğŸ ç‚¹å‡»ä¸Šä¼ è›‡å¤´å›¾ç‰‡
            </label>
            <input type="file" id="head-upload" accept="image/*">
            <p class="upload-tip">æ”¯æŒJPG/PNGæ ¼å¼ï¼Œå»ºè®®60x60æ­£æ–¹å½¢å›¾ç‰‡ï¼ˆé€æ˜èƒŒæ™¯æ›´ä½³ï¼‰</p>
        </div>
        <!-- è›‡èº«ä¸Šä¼  -->
        <div class="skin-upload-group">
            <label class="upload-label" for="body-upload">
                ğŸ“ ç‚¹å‡»ä¸Šä¼ è›‡èº«å›¾ç‰‡
            </label>
            <input type="file" id="body-upload" accept="image/*">
            <p class="upload-tip">æ”¯æŒJPG/PNGæ ¼å¼ï¼Œå»ºè®®60x60æ­£æ–¹å½¢å›¾ç‰‡ï¼ˆé€æ˜èƒŒæ™¯æ›´ä½³ï¼‰</p>
        </div>
        <!-- æ–°å¢ï¼šè›‡å°¾ä¸Šä¼  -->
        <div class="skin-upload-group">
            <label class="upload-label" for="tail-upload">
                ğŸŒ€ ç‚¹å‡»ä¸Šä¼ è›‡å°¾å›¾ç‰‡
            </label>
            <input type="file" id="tail-upload" accept="image/*">
            <p class="upload-tip">æ”¯æŒJPG/PNGæ ¼å¼ï¼Œå»ºè®®60x60æ­£æ–¹å½¢å›¾ç‰‡ï¼ˆé€æ˜èƒŒæ™¯æ›´ä½³ï¼‰</p>
        </div>
        <!-- é¢„è§ˆå®¹å™¨ - ä¸‰ä¸ªé¢„è§ˆ -->
        <div class="preview-container">
            <div class="preview-item">
                <div class="preview-box" id="head-preview">
                    <span>è›‡å¤´é¢„è§ˆ</span>
                </div>
                <p>è›‡å¤´</p>
            </div>
            <div class="preview-item">
                <div class="preview-box" id="body-preview">
                    <span>è›‡èº«é¢„è§ˆ</span>
                </div>
                <p>è›‡èº«</p>
            </div>
            <div class="preview-item">
                <div class="preview-box" id="tail-preview">
                    <span>è›‡å°¾é¢„è§ˆ</span>
                </div>
                <p>è›‡å°¾</p>
            </div>
        </div>
        <div class="modal-btn-group">
            <button class="btn btn-sub" onclick="cancelCustomSkin()">å–æ¶ˆ</button>
            <button class="btn btn-main" onclick="confirmCustomSkin()">ç¡®è®¤ä½¿ç”¨</button>
        </div>
    </div>
    <!-- é¦–é¡µï¼ˆä¿®å¤æ“æ§/éš¾åº¦æŒ‰é’®å¸ƒå±€ï¼‰ -->
    <div id="game-home">
        <h1 class="home-title">æˆ‘æ˜¯è´ªåƒè›‡ ğŸ</h1>
        <div class="year-theme">ğŸ´ 2026é©¬å¹´æ–°æ˜¥ç‰ˆ ğŸ§§</div>
        <!-- æ“æ§æ–¹å¼ -->
        <div class="option-group">
            <div class="option-title" style="display: flex; align-items: center; gap: 8px;">
                <span>ğŸ®</span> æ“æ§æ–¹å¼
            </div>
            <div class="mode-options">
                <button class="mode-btn active" data-control="keyboard">é”®ç›˜æ“æ§</button>
                <button class="mode-btn" data-control="joystick">æ‘‡æ†æ“æ§</button>
            </div>
        </div>
        <!-- éš¾åº¦é€‰æ‹© -->
        <div class="option-group">
            <div class="option-title" style="display: flex; align-items: center; gap: 8px; margin-top: 15px;">
                <span>ğŸ¢</span> æ¸¸æˆéš¾åº¦
            </div>
            <div class="mode-options">
                <button class="mode-btn active" data-speed="200">ç®€å•</button>
                <button class="mode-btn" data-speed="150">ä¸­ç­‰</button>
                <button class="mode-btn" data-speed="120">å›°éš¾</button>
            </div>
        </div>
        <!-- çš®è‚¤é€‰æ‹© -->
        <div class="option-group">
            <div class="option-title">ğŸ¨ è›‡è›‡çš®è‚¤</div>
            <div class="skin-options">
                <div class="skin-btn active" data-skin="year" title="é©¬å¹´ä¸»é¢˜">ğŸ´</div>
                <div class="skin-btn" data-skin="red" title="ä¸­å›½çº¢">ğŸ”´</div>
                <div class="skin-btn" data-skin="gold" title="é»„é‡‘">ğŸŸ¡</div>
                <div class="skin-btn" data-skin="green" title="ç¿¡ç¿ ">ğŸŸ¢</div>
                <div class="skin-btn" data-skin="blue" title="å®çŸ³">ğŸ”µ</div>
                <div class="skin-btn custom-skin-btn" id="custom-skin-btn" title="è‡ªå®šä¹‰çš®è‚¤">
                    ğŸ“·<br>è‡ªå®šä¹‰
                </div>
            </div>
        </div>
        <!-- åŠŸèƒ½æŒ‰é’® -->
        <button class="btn btn-primary" id="start-btn">å¼€å§‹æ¸¸æˆ ğŸ®</button>
        <button class="btn btn-sub" onclick="showRank()">æŸ¥çœ‹æ’è¡Œæ¦œ ğŸ†</button>
    </div>
    <!-- æ¸¸æˆç•Œé¢ -->
    <div class="header" id="game-header" style="display: none;">
        <div class="stat-box">å¾—åˆ†: <span id="score">0</span></div>
        <div class="stat-box" id="combo-ui">Combo x1</div>
        <div class="stat-box">æœ€é«˜: <span id="high-score">0</span></div>
        <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’®ï¼ˆä¿®å¤é‡å ï¼‰ -->
        <div class="game-controls">
            <button class="btn btn-sub" id="pause-btn" title="æš‚åœæ¸¸æˆ">â¸ï¸</button>
            <button class="btn btn-main" id="home-btn" title="è¿”å›ä¸»é¡µ">ğŸ </button>
        </div>
    </div>
    <div id="game-wrapper">
        <div id="combo-tip">COMBO!</div>
        <canvas id="game-canvas"></canvas>
        <!-- æš‚åœé¢æ¿ -->
        <div id="pause-panel">
            <h2 class="panel-title">æ¸¸æˆæš‚åœ â¸ï¸</h2>
            <button class="btn btn-main" onclick="togglePause()">ç»§ç»­æ¸¸æˆ</button>
            <button class="btn btn-sub" onclick="backToHome()">è¿”å›é¦–é¡µ</button>
        </div>
        <!-- ç»“æŸé¢æ¿ï¼ˆæ–°æ˜¥æˆ˜æŠ¥ï¼‰ -->
        <div id="over-panel" class="overlay">
            <h2 style="color: var(--red); margin-bottom: 10px;">ğŸ§§ é©¬åˆ°æˆåŠŸ Â· æˆ˜æŠ¥</h2>
            <div class="share-card">
                <div id="achievement-title" style="font-weight: bold; color: #d35400;">[ ä¸›æ—èŒè›‡ ]</div>
                <div class="route-summary-container">
                    <canvas id="route-summary-map"></canvas>
                </div>
                <p style="font-size: 12px; color: #666;">
                    æ­¥æ•°: <span id="res-steps">0</span> | 
                    è‹¹æœ: <span id="res-apples">0</span> | 
                    éš¾åº¦: <span id="res-difficulty">ç®€å•</span>
                </p>
            </div>
            <div class="btn-group">
                <button class="btn btn-main" onclick="restartGame()">å†åˆ›è¾‰ç…Œ</button>
                <button class="btn btn-sub" onclick="saveAsImage()">åˆ†äº«æˆ˜ç»©</button>
                <button class="btn btn-sub" onclick="backToHome()">è¿”å›é¦–é¡µ</button>
            </div>
        </div>
    </div>
    <!-- è·Ÿéšæ‰‹æŒ‡ç§»åŠ¨çš„æ‘‡æ† -->
    <div id="joystick-area">
        <div id="knob"></div>
    </div>
    <!-- æ’è¡Œæ¦œå¼¹çª— -->
    <div id="rank-modal">
        <h2 class="panel-title">ğŸ† æ–°æ˜¥æ’è¡Œæ¦œ</h2>
        <div class="rank-list" id="rank-list">
            <!-- æ’è¡Œæ¦œå†…å®¹åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <button class="btn btn-sub" onclick="closeRank()">å…³é—­</button>
    </div>
    <!-- éŸ³é¢‘èµ„æº -->
    <audio id="bg-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-joyful-festival-1369.mp3" type="audio/mpeg">
    </audio>
    <audio id="eat-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" type="audio/mpeg">
    </audio>
    <audio id="hit-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ========== æ ¸å¿ƒé…ç½® ==========
        const config = {
            control: "keyboard",
            speed: 200,
            skin: "year",
            gridSize: 20,
            musicOn: true,
            soundOn: true,
            aiEnabled: false,
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            // è‡ªå®šä¹‰çš®è‚¤é…ç½® - å‡çº§ä¸ºè›‡å¤´/è›‡èº«/è›‡å°¾
            customSkin: {
                enabled: false,
                headImg: null,      
                bodyImg: null,      
                tailImg: null,      
                headImgUrl: "",     
                bodyImgUrl: "",     
                tailImgUrl: "",     
                headLoaded: false,  
                bodyLoaded: false,
                tailLoaded: false,  
                forceApply: false
            },
            colors: {
                year: { head: "#e67e22", body: "#f39c12", eye: "#fff", bg: "#fff8e6" },
                red: { head: "#e74c3c", body: "#c0392b", eye: "#fff", bg: "#ffebee" },
                gold: { head: "#f1c40f", body: "#f39c12", eye: "#000", bg: "#fff9c4" },
                green: { head: "#2ecc71", body: "#27ae60", eye: "#fff", bg: "#e8f5e9" },
                blue: { head: "#3498db", body: "#2980b9", eye: "#fff", bg: "#e3f2fd" }
            }
        };

        // æ–°å¢ï¼šçš®è‚¤åŠ è½½çŠ¶æ€å…¨å±€å˜é‡
        let skinLoadState = {
            isCustomSelected: false, 
            isAllLoaded: false,      
            loadTip: ""              
        };

        // æ‘‡æ†æ ¸å¿ƒå˜é‡ï¼ˆè·Ÿéšæ‰‹æŒ‡ä¸“ç”¨ï¼‰
        let joystickActive = false;
        let joystickX = 0;
        let joystickY = 0;

        // æ¸¸æˆæ ¸å¿ƒå˜é‡
        let canvas, ctx;
        let snake = [];
        let food = {};
        let dx = 0;
        let dy = -1;
        let score = 0;
        let highest = 0;
        let gameLoop = null;
        let isPaused = false;
        let isGameOver = false;
        let rankData = [];
        let combo = 1;
        let comboSteps = 0;
        let moveRoute = [];
        let appleCount = 0;
        let gameStartTime = 0;
        // DOMå…ƒç´ ç¼“å­˜
        const dom = {
            gameHome: document.getElementById("game-home"),
            gameHeader: document.getElementById("game-header"),
            gameWrapper: document.getElementById("game-wrapper"),
            canvas: document.getElementById("game-canvas"),
            joystickArea: document.getElementById("joystick-area"),
            overPanel: document.getElementById("over-panel"),
            pausePanel: document.getElementById("pause-panel"),
            customSkinModal: document.getElementById("custom-skin-modal"),
            customSkinBtn: document.getElementById("custom-skin-btn"),
            headUpload: document.getElementById("head-upload"),
            bodyUpload: document.getElementById("body-upload"),
            tailUpload: document.getElementById("tail-upload"),
            headPreview: document.getElementById("head-preview"),
            bodyPreview: document.getElementById("body-preview"),
            tailPreview: document.getElementById("tail-preview"),
            mask: document.getElementById("mask"),
            audio: {
                bgMusic: document.getElementById("bg-music"),
                eatSound: document.getElementById("eat-sound"),
                hitSound: document.getElementById("hit-sound")
            }
        };
        // ========== åˆå§‹åŒ– ==========
        window.onload = function() {
            if (config.isMobile) {
                document.querySelector('[data-control="joystick"]').click();
            }
            initCanvas();
            initSummaryCanvas();
            loadHighestScore();
            loadRankData();
            bindAllEvents();
            bindCustomSkinEvents();
            bindModalCloseEvents();
            playBgMusic();
            initJoystick(); // åˆå§‹åŒ–è·Ÿéšæ‰‹æŒ‡çš„æ‘‡æ†
            initGameData();
            drawGame();
            
            // æ–°å¢ï¼šåˆå§‹åŒ–å¼€å§‹æ¸¸æˆæŒ‰é’®çŠ¶æ€
            updateSkinLoadState();
            updateStartBtnState();
            
            window.addEventListener('resize', () => {
                if (!isGameOver) {
                    resizeCanvas();
                    drawGame();
                }
            });
        };
        // ========== å¼¹çª—å…³é—­äº‹ä»¶ç»‘å®š ==========
        function bindModalCloseEvents() {
            dom.mask.addEventListener("click", function() {
                dom.customSkinModal.style.display = "none";
                dom.rankModal.style.display = "none";
                dom.mask.style.display = "none";
            });
            const modalContents = [
                dom.customSkinModal,
                dom.rankModal,
                document.querySelector('.guide-content')
            ];
            modalContents.forEach(el => {
                if (el) {
                    el.addEventListener("click", function(e) {
                        e.stopPropagation();
                    });
                }
            });
        }
        // ========== Canvasåˆå§‹åŒ– ==========
        function initCanvas() {
            canvas = dom.canvas;
            ctx = canvas.getContext("2d");
            resizeCanvas();
        }
        function initSummaryCanvas() {
            const sCanvas = document.getElementById("route-summary-map");
            sCanvas.width = 240;
            sCanvas.height = 160;
        }
        function resizeCanvas() {
            const wrapper = document.getElementById("game-wrapper");
            const size = Math.min(wrapper.clientWidth - 20, 400);
            canvas.width = size;
            canvas.height = size;
        }
        // ========== äº‹ä»¶ç»‘å®š ==========
        function bindAllEvents() {
            document.getElementById("ai-toggle").addEventListener("click", toggleAI);
            document.getElementById("music-btn").addEventListener("click", toggleMusic);
            document.getElementById("sound-btn").addEventListener("click", toggleSound);
            document.querySelectorAll(".mode-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const siblings = Array.from(btn.parentElement.children);
                    siblings.forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    if (btn.dataset.control) config.control = btn.dataset.control;
                    if (btn.dataset.speed) config.speed = parseInt(btn.dataset.speed);
                });
            });
            document.querySelectorAll(".skin-btn:not(#custom-skin-btn)").forEach(btn => {
                btn.addEventListener("click", () => {
                    config.customSkin.enabled = false;
                    config.customSkin.headLoaded = false;
                    config.customSkin.bodyLoaded = false;
                    config.customSkin.tailLoaded = false;
                    config.customSkin.forceApply = false;
                    document.querySelectorAll(".skin-btn").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    config.skin = btn.dataset.skin;
                    if (!isGameOver) drawGame();
                });
            });
            document.getElementById("start-btn").addEventListener("click", startGame);
            document.addEventListener("keydown", handleKeydown);
            document.addEventListener("keydown", (e) => {
                if (e.key === " " && dom.gameWrapper.style.display !== "none" && !isGameOver) {
                    togglePause();
                }
            });
            document.getElementById("pause-btn").addEventListener("click", togglePause);
            document.getElementById("home-btn").addEventListener("click", backToHome);
        }
        // ========== è‡ªå®šä¹‰çš®è‚¤äº‹ä»¶ï¼ˆå‡çº§ä¸ºè›‡å¤´/è›‡èº«/è›‡å°¾ï¼‰ ==========
        function bindCustomSkinEvents() {
            dom.customSkinBtn.addEventListener("click", () => {
                dom.mask.style.display = "block";
                dom.customSkinModal.style.display = "block";
            });

            // è›‡å¤´ä¸Šä¼ 
            dom.headUpload.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) {
                    config.customSkin.headLoaded = false;
                    updateSkinLoadState();
                    skinLoadState.loadTip = "æ­£åœ¨åŠ è½½è›‡å¤´å›¾ç‰‡...";
                    updateStartBtnState();
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.crossOrigin = "anonymous";
                        img.onload = function() {
                            config.customSkin.headImg = img;
                            config.customSkin.headImgUrl = e.target.result;
                            config.customSkin.headLoaded = true;
                            skinLoadState.loadTip = "è›‡å¤´å›¾ç‰‡åŠ è½½å®Œæˆï¼";
                            updateSkinLoadState();
                            updateStartBtnState();
                            dom.headPreview.innerHTML = "";
                            const imgEl = document.createElement("img");
                            imgEl.src = e.target.result;
                            imgEl.className = "preview-img";
                            dom.headPreview.appendChild(imgEl);
                            if (dom.gameWrapper.style.display === "block" && !isGameOver) {
                                drawGame();
                            }
                        };
                        img.onerror = function() {
                            alert("è›‡å¤´å›¾ç‰‡åŠ è½½å¤±è´¥ï¼");
                            config.customSkin.headLoaded = false;
                            skinLoadState.loadTip = "è›‡å¤´å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ ï¼";
                            updateSkinLoadState();
                            updateStartBtnState();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // è›‡èº«ä¸Šä¼ 
            dom.bodyUpload.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) {
                    config.customSkin.bodyLoaded = false;
                    updateSkinLoadState();
                    skinLoadState.loadTip = "æ­£åœ¨åŠ è½½è›‡èº«å›¾ç‰‡...";
                    updateStartBtnState();
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.crossOrigin = "anonymous";
                        img.onload = function() {
                            config.customSkin.bodyImg = img;
                            config.customSkin.bodyImgUrl = e.target.result;
                            config.customSkin.bodyLoaded = true;
                            skinLoadState.loadTip = "è›‡èº«å›¾ç‰‡åŠ è½½å®Œæˆï¼";
                            updateSkinLoadState();
                            updateStartBtnState();
                            dom.bodyPreview.innerHTML = "";
                            const imgEl = document.createElement("img");
                            imgEl.src = e.target.result;
                            imgEl.className = "preview-img";
                            dom.bodyPreview.appendChild(imgEl);
                            if (dom.gameWrapper.style.display === "block" && !isGameOver) {
                                drawGame();
                            }
                        };
                        img.onerror = function() {
                            alert("è›‡èº«å›¾ç‰‡åŠ è½½å¤±è´¥ï¼");
                            config.customSkin.bodyLoaded = false;
                            skinLoadState.loadTip = "è›‡èº«å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ ï¼";
                            updateSkinLoadState();
                            updateStartBtnState();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // è›‡å°¾ä¸Šä¼ äº‹ä»¶
            dom.tailUpload.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) {
                    config.customSkin.tailLoaded = false;
                    updateSkinLoadState();
                    skinLoadState.loadTip = "æ­£åœ¨åŠ è½½è›‡å°¾å›¾ç‰‡...";
                    updateStartBtnState();
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.crossOrigin = "anonymous";
                        img.onload = function() {
                            config.customSkin.tailImg = img;
                            config.customSkin.tailImgUrl = e.target.result;
                            config.customSkin.tailLoaded = true;
                            skinLoadState.loadTip = "è›‡å°¾å›¾ç‰‡åŠ è½½å®Œæˆï¼";
                            updateSkinLoadState();
                            updateStartBtnState();
                            dom.tailPreview.innerHTML = "";
                            const imgEl = document.createElement("img");
                            imgEl.src = e.target.result;
                            imgEl.className = "preview-img";
                            dom.tailPreview.appendChild(imgEl);
                            if (dom.gameWrapper.style.display === "block" && !isGameOver) {
                                drawGame();
                            }
                        };
                        img.onerror = function() {
                            alert("è›‡å°¾å›¾ç‰‡åŠ è½½å¤±è´¥ï¼");
                            config.customSkin.tailLoaded = false;
                            skinLoadState.loadTip = "è›‡å°¾å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ ï¼";
                            updateSkinLoadState();
                            updateStartBtnState();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        // ========== çš®è‚¤åŠ è½½çŠ¶æ€ç®¡ç† ==========
        function updateSkinLoadState() {
            skinLoadState.isCustomSelected = dom.customSkinBtn.classList.contains("active");
            skinLoadState.isAllLoaded = config.customSkin.headLoaded && config.customSkin.bodyLoaded && config.customSkin.tailLoaded;
            
            if (!skinLoadState.isCustomSelected) {
                skinLoadState.isAllLoaded = true;
                skinLoadState.loadTip = "";
            } else if (skinLoadState.isCustomSelected && !skinLoadState.isAllLoaded) {
                skinLoadState.loadTip = skinLoadState.loadTip || "è¯·ç­‰å¾…æ‰€æœ‰çš®è‚¤å›¾ç‰‡åŠ è½½å®Œæˆ...";
            } else {
                skinLoadState.loadTip = "æ‰€æœ‰çš®è‚¤åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æ¸¸æˆï¼";
            }
        }

        function updateStartBtnState() {
            const startBtn = document.getElementById("start-btn");
            if (skinLoadState.isCustomSelected && !skinLoadState.isAllLoaded) {
                startBtn.disabled = true;
                startBtn.style.opacity = "0.6";
                startBtn.style.cursor = "not-allowed";
                startBtn.innerHTML = `â³ ${skinLoadState.loadTip}`;
            } else {
                startBtn.disabled = false;
                startBtn.style.opacity = "1";
                startBtn.style.cursor = "pointer";
                startBtn.innerHTML = "å¼€å§‹æ¸¸æˆ ğŸ®";
            }
        }

        document.querySelectorAll(".skin-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                setTimeout(() => {
                    updateSkinLoadState();
                    updateStartBtnState();
                }, 100);
            });
        });
        // ========== å¼¹çª—æ§åˆ¶å‡½æ•° ==========
        function closeGuide() {
            document.getElementById("guide-page").style.display = "none";
        }
        function showRank() {
            dom.mask.style.display = "block";
            dom.rankModal.style.display = "flex";
            renderRank();
        }
        function closeRank() {
            dom.rankModal.style.display = "none";
            dom.mask.style.display = "none";
        }
        function cancelCustomSkin() {
            dom.mask.style.display = "none";
            dom.customSkinModal.style.display = "none";
            dom.headUpload.value = "";
            dom.bodyUpload.value = "";
            dom.tailUpload.value = "";
            dom.headPreview.innerHTML = "<span>è›‡å¤´é¢„è§ˆ</span>";
            dom.bodyPreview.innerHTML = "<span>è›‡èº«é¢„è§ˆ</span>";
            dom.tailPreview.innerHTML = "<span>è›‡å°¾é¢„è§ˆ</span>";
        }
        function confirmCustomSkin() {
            if (!config.customSkin.headLoaded || !config.customSkin.bodyLoaded || !config.customSkin.tailLoaded) {
                alert("è¯·ä¸Šä¼ å¹¶ç­‰å¾…æ‰€æœ‰å›¾ç‰‡ï¼ˆè›‡å¤´ã€è›‡èº«ã€è›‡å°¾ï¼‰åŠ è½½å®Œæˆï¼");
                return;
            }
            config.skin = "custom";
            config.customSkin.enabled = true;
            config.customSkin.forceApply = true;
            document.querySelectorAll(".skin-btn").forEach(b => b.classList.remove("active"));
            dom.customSkinBtn.classList.add("active");
            skinLoadState.isCustomSelected = true;
            skinLoadState.isAllLoaded = true;
            updateStartBtnState();
            cancelCustomSkin();
            if (dom.gameWrapper.style.display === "block" && !isGameOver) {
                drawGame();
            } else {
                initGameData();
                drawGame();
            }
        }
        // ========== å·¥å…·å‡½æ•° ==========
        function playSound(type) {
            if (!config.soundOn) return;
            const sound = dom.audio[type];
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥:", e));
            }
        }
        function playBgMusic() {
            if (config.musicOn) {
                dom.audio.bgMusic.play().catch(e => console.log("èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥:", e));
            }
        }
        function toggleMusic() {
            config.musicOn = !config.musicOn;
            const btn = document.getElementById("music-btn");
            if (config.musicOn) {
                dom.audio.bgMusic.play();
                btn.style.background = "rgba(255,255,255,0.9)";
                btn.style.color = "#f39c12";
            } else {
                dom.audio.bgMusic.pause();
                btn.style.background = "#e74c3c";
                btn.style.color = "white";
            }
        }
        function toggleSound() {
            config.soundOn = !config.soundOn;
            const btn = document.getElementById("sound-btn");
            if (!config.soundOn) {
                btn.style.background = "#e74c3c";
                btn.style.color = "white";
            } else {
                btn.style.background = "rgba(255,255,255,0.9)";
                btn.style.color = "#f39c12";
            }
        }
        function toggleAI() {
            config.aiEnabled = !config.aiEnabled;
            const btn = document.getElementById("ai-toggle");
            if (config.aiEnabled) {
                btn.classList.add("ai-on");
            } else {
                btn.classList.remove("ai-on");
            }
        }
        // ========== å®Œå…¨è·Ÿéšæ‰‹æŒ‡çš„æ‘‡æ†åˆå§‹åŒ–å‡½æ•° ==========
        function initJoystick() {
            const stick = document.getElementById("joystick-area");
            const knob = document.getElementById("knob");

            const radius = stick.offsetWidth / 2;
            const knobRadius = knob.offsetWidth / 2;
            const maxMove = radius - knobRadius;

            // è®¡ç®—å°çƒä½ç½®
            function getKnobPosition(clientX, clientY) {
                const rect = stick.getBoundingClientRect();
                const centerX = rect.left + radius;
                const centerY = rect.top + radius;

                let dx = clientX - centerX;
                let dy = clientY - centerY;

                const dist = Math.sqrt(dx*dx + dy*dy);

                if (dist > maxMove) {
                    const scale = maxMove / dist;
                    dx *= scale;
                    dy *= scale;
                }

                return { x: dx, y: dy };
            }

            // ç§»åŠ¨å°çƒ
            function moveKnob(x, y) {
                knob.style.transform = `translate(${x}px, ${y}px)`;
            }

            // è§¦æ‘¸å¼€å§‹
            stick.addEventListener("touchstart", (e) => {
                e.preventDefault();
                joystickActive = true;
                const touch = e.touches[0];
                const pos = getKnobPosition(touch.clientX, touch.clientY);
                moveKnob(pos.x, pos.y);
                // è®¡ç®—æ‘‡æ†æ–¹å‘å€¼
                joystickX = pos.x / maxMove;
                joystickY = pos.y / maxMove;
            }, { passive: false });

            // è§¦æ‘¸ç§»åŠ¨ï¼ˆæ ¸å¿ƒï¼šå®æ—¶è·Ÿéšæ‰‹æŒ‡ï¼‰
            document.addEventListener("touchmove", (e) => {
                if (!joystickActive) return;
                e.preventDefault();
                const touch = e.touches[0];
                const pos = getKnobPosition(touch.clientX, touch.clientY);
                moveKnob(pos.x, pos.y);
                // å®æ—¶æ›´æ–°æ–¹å‘å€¼
                joystickX = pos.x / maxMove;
                joystickY = pos.y / maxMove;
            }, { passive: false });

            // è§¦æ‘¸ç»“æŸ
            document.addEventListener("touchend", () => {
                if (!joystickActive) return;
                joystickActive = false;
                moveKnob(0, 0); // å›åˆ°ä¸­å¿ƒ
                joystickX = 0;
                joystickY = 0;
            });

            // é¼ æ ‡æ”¯æŒ
            stick.addEventListener("mousedown", (e) => {
                joystickActive = true;
                const pos = getKnobPosition(e.clientX, e.clientY);
                moveKnob(pos.x, pos.y);
                joystickX = pos.x / maxMove;
                joystickY = pos.y / maxMove;
            });

            document.addEventListener("mousemove", (e) => {
                if (!joystickActive) return;
                const pos = getKnobPosition(e.clientX, e.clientY);
                moveKnob(pos.x, pos.y);
                joystickX = pos.x / maxMove;
                joystickY = pos.y / maxMove;
            });

            document.addEventListener("mouseup", () => {
                if (!joystickActive) return;
                joystickActive = false;
                moveKnob(0, 0);
                joystickX = 0;
                joystickY = 0;
            });
        }
        // ========== æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ==========
        function initGameData() {
            const mid = Math.floor(config.gridSize / 2);
            snake = [
                { x: mid, y: mid },
                { x: mid, y: mid + 1 },
                { x: mid, y: mid + 2 }
            ];
            dx = 0;
            dy = -1;
            joystickX = 0;
            joystickY = 0;
            generateFood();
            score = 0;
            combo = 1;
            comboSteps = 0;
            moveRoute = [];
            appleCount = 0;
            isGameOver = false;
            isPaused = false;
            moveRoute.push({x: mid, y: mid, isApple: false});
            document.getElementById("score").innerText = "0";
            document.getElementById("combo-ui").innerText = "Combo x1";
            document.getElementById("high-score").innerText = highest;
            dom.overPanel.style.display = "none";
            dom.pausePanel.style.display = "none";
        }
        
        function startGame() {
            if (skinLoadState.isCustomSelected && !skinLoadState.isAllLoaded) {
                alert(`æ— æ³•å¼€å§‹æ¸¸æˆï¼š${skinLoadState.loadTip}`);
                return;
            }
            
            dom.gameHome.style.display = "none";
            dom.gameHeader.style.display = "flex";
            dom.gameWrapper.style.display = "block";
            
            if (config.control === "joystick") {
                dom.joystickArea.style.display = "block";
                joystickX = 0;
                joystickY = 0;
                dx = 0;
                dy = -1;
            } else {
                dom.joystickArea.style.display = "none";
            }
            
            gameStartTime = new Date().getTime();
            initGameData();
            clearInterval(gameLoop);
            gameLoop = setInterval(updateGame, config.speed);
            resizeCanvas();
            requestAnimationFrame(drawGame);
        }
        
        function updateGame() {
            if (isPaused || isGameOver) return;

            // ========== æ‘‡æ†æ–¹å‘æ§åˆ¶ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰ ==========
            if (config.control === "joystick") {
                const deadzone = 0.2; // æ­»åŒºï¼Œé¿å…è½»å¾®è§¦æ‘¸è§¦å‘

                if (Math.abs(joystickX) > Math.abs(joystickY)) {
                    // æ°´å¹³æ–¹å‘ä¼˜å…ˆ
                    if (joystickX > deadzone && dx !== -1) {
                        dx = 1; dy = 0;
                    } else if (joystickX < -deadzone && dx !== 1) {
                        dx = -1; dy = 0;
                    }
                } else {
                    // å‚ç›´æ–¹å‘ä¼˜å…ˆ
                    if (joystickY > deadzone && dy !== -1) {
                        dx = 0; dy = 1;
                    } else if (joystickY < -deadzone && dy !== 1) {
                        dx = 0; dy = -1;
                    }
                }
            }
            
            if (config.aiEnabled) {
                const aiDirection = findShortestPath();
                if (aiDirection) {
                    dx = aiDirection.x;
                    dy = aiDirection.y;
                }
            }
            
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            comboSteps++;
            moveRoute.push({x: head.x, y: head.y, isApple: false});
            const isWallCollision = head.x < 0 || head.x >= config.gridSize || head.y < 0 || head.y >= config.gridSize;
            const isSelfCollision = snake.some((seg, index) => {
                return index > 0 && seg.x === head.x && seg.y === head.y;
            });
            
            if (isWallCollision || isSelfCollision) {
                gameOver();
                return;
            }
            
            snake.unshift(head);
            if (head.x === food.x && head.y === food.y) {
                handleScore();
                appleCount++;
                moveRoute[moveRoute.length-1].isApple = true;
                playSound("eatSound");
                generateFood();
                if(navigator.vibrate) navigator.vibrate(20);
            } else {
                snake.pop();
            }
            
            drawGame();
        }
        
        function handleScore() {
            if(comboSteps < 10) {
                combo++;
                showComboEffect();
            } else {
                combo = 1;
            }
            score += (10 * combo);
            document.getElementById("score").innerText = score;
            document.getElementById("combo-ui").innerText = `Combo x${combo}`;
            comboSteps = 0;
        }
        
        function showComboEffect() {
            const tip = document.getElementById('combo-tip');
            tip.style.opacity = '1';
            tip.style.transform = 'translate(-50%, -80%) scale(1.2)';
            setTimeout(() => { 
                tip.style.opacity = '0'; 
                tip.style.transform = 'translate(-50%, -50%) scale(1)'; 
            }, 500);
        }
        
        // ç»˜åˆ¶æ¸¸æˆ
        function drawGame() {
            const cellSize = canvas.width / config.gridSize;
            let skin = config.colors[config.skin];
            if (config.skin === "custom") {
                skin = { head: "transparent", body: "transparent", tail: "transparent", eye: "#fff", bg: "#fffcf5" };
            }
            ctx.fillStyle = config.customSkin.enabled ? "#fffcf5" : skin.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = "rgba(0,0,0,0.05)";
            ctx.lineWidth = 1;
            for (let i = 0; i <= config.gridSize; i++) {
                ctx.beginPath();
                ctx.moveTo(i * cellSize, 0);
                ctx.lineTo(i * cellSize, canvas.height);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, i * cellSize);
                ctx.lineTo(canvas.width, i * cellSize);
                ctx.stroke();
            }
            // ç»˜åˆ¶è›‡
            snake.forEach((seg, index) => {
                const x = seg.x * cellSize;
                const y = seg.y * cellSize;
                // è›‡å¤´
                if (index === 0) {
                    if (config.customSkin.enabled && config.customSkin.headLoaded && config.customSkin.headImg && config.customSkin.headImg.complete) {
                        ctx.save();
                        ctx.shadowBlur = 0;
                        ctx.strokeStyle = "transparent";
                        ctx.fillStyle = "transparent";
                        ctx.beginPath();
                        ctx.roundRect(x + 2, y + 2, cellSize - 4, cellSize - 4, 8);
                        ctx.clip();
                        ctx.drawImage(
                            config.customSkin.headImg, 
                            0, 0, config.customSkin.headImg.width, config.customSkin.headImg.height,
                            x + 2, y + 2, cellSize - 4, cellSize - 4
                        );
                        ctx.restore();
                        ctx.shadowBlur = 5;
                        ctx.shadowColor = "rgba(0,0,0,0.2)";
                    } else {
                        ctx.fillStyle = skin.head;
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = skin.head;
                        ctx.beginPath();
                        ctx.roundRect(x + 2, y + 2, cellSize - 4, cellSize - 4, 8);
                        ctx.fill();
                        ctx.fillStyle = skin.eye;
                        const eyeSize = cellSize / 6;
                        let eye1X = x + cellSize * 0.3;
                        let eye1Y = y + cellSize * 0.4;
                        let eye2X = x + cellSize * 0.7;
                        let eye2Y = y + cellSize * 0.4;
                        ctx.beginPath();
                        ctx.arc(eye1X, eye1Y, eyeSize, 0, Math.PI * 2);
                        ctx.arc(eye2X, eye2Y, eyeSize, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } 
                // è›‡å°¾
                else if (index === snake.length - 1) {
                    if (config.customSkin.enabled && config.customSkin.tailLoaded && config.customSkin.tailImg && config.customSkin.tailImg.complete) {
                        ctx.save();
                        ctx.shadowBlur = 0;
                        ctx.strokeStyle = "transparent";
                        ctx.fillStyle = "transparent";
                        ctx.beginPath();
                        ctx.roundRect(x + 3, y + 3, cellSize - 6, cellSize - 6, 6);
                        ctx.clip();
                        ctx.drawImage(
                            config.customSkin.tailImg, 
                            0, 0, config.customSkin.tailImg.width, config.customSkin.tailImg.height,
                            x + 3, y + 3, cellSize - 6, cellSize - 6
                        );
                        ctx.restore();
                    } else {
                        ctx.fillStyle = skin.body;
                        ctx.shadowBlur = 0;
                        ctx.beginPath();
                        ctx.roundRect(x + 3, y + 3, cellSize - 6, cellSize - 6, 6);
                        ctx.fill();
                    }
                }
                // è›‡èº«
                else {
                    if (config.customSkin.enabled && config.customSkin.bodyLoaded && config.customSkin.bodyImg && config.customSkin.bodyImg.complete) {
                        ctx.save();
                        ctx.shadowBlur = 0;
                        ctx.strokeStyle = "transparent";
                        ctx.fillStyle = "transparent";
                        ctx.beginPath();
                        ctx.roundRect(x + 3, y + 3, cellSize - 6, cellSize - 6, 4);
                        ctx.clip();
                        ctx.drawImage(
                            config.customSkin.bodyImg, 
                            0, 0, config.customSkin.bodyImg.width, config.customSkin.bodyImg.height,
                            x + 3, y + 3, cellSize - 6, cellSize - 6
                        );
                        ctx.restore();
                    } else {
                        ctx.fillStyle = skin.body;
                        ctx.shadowBlur = 0;
                        ctx.beginPath();
                        ctx.roundRect(x + 3, y + 3, cellSize - 6, cellSize - 6, 4);
                        ctx.fill();
                    }
                }
            });
            // ç»˜åˆ¶é£Ÿç‰©
            ctx.shadowBlur = 15;
            ctx.shadowColor = "#e74c3c";
            ctx.fillStyle = "#e74c3c";
            ctx.beginPath();
            ctx.arc(food.x * cellSize + cellSize/2, food.y * cellSize + cellSize/2, cellSize/3, 0, Math.PI*2);
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.fillStyle = "#fff";
            ctx.font = (cellSize * 0.6) + "px Arial";
            ctx.textAlign = "center";
            ctx.fillText("ğŸ", food.x * cellSize + cellSize/2, food.y * cellSize + cellSize/2 + cellSize/6);
        }
        
        function generateFood() {
            food = {
                x: Math.floor(Math.random() * config.gridSize),
                y: Math.floor(Math.random() * config.gridSize)
            };
            if (snake.some(s => s.x === food.x && s.y === food.y)) {
                generateFood();
            }
        }
        
        function handleKeydown(e) {
            if (isPaused || isGameOver) return;
            switch(e.key) {
                case "ArrowUp":
                    if (dy !== 1) {
                        dx = 0;
                        dy = -1;
                    }
                    break;
                case "ArrowDown":
                    if (dy !== -1) {
                        dx = 0;
                        dy = 1;
                    }
                    break;
                case "ArrowLeft":
                    if (dx !== 1) {
                        dx = -1;
                        dy = 0;
                    }
                    break;
                case "ArrowRight":
                    if (dx !== -1) {
                        dx = 1;
                        dy = 0;
                    }
                    break;
            }
        }
        
        function findShortestPath() { 
            const dxFood = food.x - head.x;
            const dyFood = food.y - head.y;
            if (Math.abs(dxFood) > Math.abs(dyFood)) {
                if (dxFood > 0 && dx !== -1) {
                    return {x: 1, y: 0};
                } else if (dxFood < 0 && dx !== 1) {
                    return {x: -1, y: 0};
                }
            }
            if (dyFood > 0 && dy !== -1) {
                return {x: 0, y: 1};
            } else if (dyFood < 0 && dy !== 1) {
                return {x: 0, y: -1};
            }
            return null;
        }
        
        function togglePause() {
            isPaused = !isPaused;
            if (isPaused) {
                dom.pausePanel.style.display = "flex";
            } else {
                dom.pausePanel.style.display = "none";
            }
        }
        
        function gameOver() {
            clearInterval(gameLoop);
            isGameOver = true;
            playSound("hitSound");
            if(navigator.vibrate) navigator.vibrate(200);
            if (score > highest) {
                highest = score;
                localStorage.setItem("snakeHighest", highest);
            }
            saveRankData();
            showSummary();
            dom.overPanel.style.display = "flex";
        }
        
        function showSummary() {
            document.getElementById("res-steps").innerText = moveRoute.length;
            document.getElementById("res-apples").innerText = appleCount;
            let difficulty = "ç®€å•";
            if (config.speed === 150) difficulty = "ä¸­ç­‰";
            if (config.speed === 120) difficulty = "å›°éš¾";
            document.getElementById("res-difficulty").innerText = difficulty;
            drawRouteSummary();
            let title = "[ ä¸›æ—èŒè›‡ ]";
            if (score >= 100) title = "[ è‰åŸçµè›‡ ]";
            if (score >= 200) title = "[ å³¡è°·çŒ›è›‡ ]";
            if (score >= 500) title = "[ æ²™æ¼ å·¨èŸ’ ]";
            if (score >= 1000) title = "[ ç¥é¾™é™ä¸– ]";
            document.getElementById("achievement-title").innerText = title;
        }
        
        function drawRouteSummary() {
            const sCanvas = document.getElementById("route-summary-map");
            const sCtx = sCanvas.getContext("2d");
            sCtx.clearRect(0, 0, sCanvas.width, sCanvas.height);
            sCtx.fillStyle = "#fef9ef";
            sCtx.fillRect(0, 0, sCanvas.width, sCanvas.height);
            const cellSize = Math.min(sCanvas.width / config.gridSize, sCanvas.height / config.gridSize);
            moveRoute.forEach((pos, index) => {
                const x = pos.x * cellSize;
                const y = pos.y * cellSize;
                sCtx.fillStyle = index === 0 ? "#e74c3c" : "#f39c12";
                if (pos.isApple) {
                    sCtx.fillStyle = "#2ecc71";
                }
                sCtx.fillRect(x, y, cellSize - 1, cellSize - 1);
            });
        }
        
        function saveAsImage() {
            const canvas = document.getElementById("route-summary-map");
            const dataURL = canvas.toDataURL("image/png");
            const link = document.createElement("a");
            link.download = `è´ªåƒè›‡æˆ˜ç»©_${score}åˆ†_${new Date().toLocaleDateString()}.png`;
            link.href = dataURL;
            link.click();
        }
        
        function loadHighestScore() {
            highest = parseInt(localStorage.getItem("snakeHighest")) || 0;
            document.getElementById("high-score").innerText = highest;
        }
        
        function saveRankData() {
            const now = new Date();
            const record = {
                score: score,
                date: now.toLocaleString(),
                timestamp: now.getTime()
            };
            rankData.push(record);
            rankData.sort((a, b) => b.score - a.score);
            rankData = rankData.slice(0, 10);
            localStorage.setItem("snakeRank", JSON.stringify(rankData));
        }
        
        function loadRankData() {
            const saved = localStorage.getItem("snakeRank");
            if (saved) {
                rankData = JSON.parse(saved);
            }
        }
        
        function renderRank() {
            const list = document.getElementById("rank-list");
            list.innerHTML = "";
            if (rankData.length === 0) {
                list.innerHTML = '<div class="rank-item"><span style="color:#7f8c8d;">æš‚æ— æ¸¸æˆè®°å½•</span></div>';
                return;
            }
            rankData.forEach((item, index) => {
                const el = document.createElement("div");
                el.className = "rank-item";
                el.innerHTML = `
                    <span class="rank-num">${index + 1}</span>
                    <span class="rank-score">${item.score} åˆ†</span>
                    <span class="rank-date">${item.date}</span>
                `;
                list.appendChild(el);
            });
        }
        
        function restartGame() {
            startGame();
        }
        
        function backToHome() {
            clearInterval(gameLoop);
            dom.gameHome.style.display = "flex";
            dom.gameHeader.style.display = "none";
            dom.gameWrapper.style.display = "none";
            dom.joystickArea.style.display = "none";
        }
    </script>
</body>
</html>
