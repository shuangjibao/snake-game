<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>æˆ‘æ˜¯è´ªåƒè›‡ ğŸ 2026é©¬å¹´æ–°æ˜¥é™å®šç‰ˆ</title>
    <style>
        :root { 
            --gold: #f39c12; 
            --red: #e74c3c; 
            --bg: #fff8e6; 
            --orange: #e67e22;
        }
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        body { 
            background: radial-gradient(circle, #fff8e6 0%, #ffe0b2 100%);
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
            touch-action: pan-y;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }
        /* ä¾§è¾¹æ»‘åŠ¨æ¡ç¾åŒ– */
        body::-webkit-scrollbar {
            width: 8px;
        }
        body::-webkit-scrollbar-track {
            background: rgba(255,248,230,0.5);
        }
        body::-webkit-scrollbar-thumb {
            background: var(--gold);
            border-radius: 4px;
        }
        body::-webkit-scrollbar-thumb:hover {
            background: var(--orange);
        }
        /* AI å¼€å…³æŒ‰é’® */
        #ai-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.9);
            border: 2px solid var(--gold);
            color: var(--gold);
            font-size: 20px;
            cursor: pointer;
            z-index: 99;
        }
        #ai-toggle.ai-on {
            background: var(--red);
            color: white;
            border-color: var(--red);
        }
        /* éŸ³æ•ˆ/éŸ³ä¹å¼€å…³ */
        .audio-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 99;
        }
        .audio-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.9);
            border: 2px solid var(--gold);
            color: var(--gold);
            font-size: 20px;
            cursor: pointer;
        }
        /* æ¸¸æˆå¼•å¯¼é¡µ */
        #guide-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
            padding: 20px;
        }
        .guide-content {
            background: rgba(255,255,255,0.95);
            border-radius: 24px;
            padding: 30px;
            max-width: 400px;
            color: #333;
            text-align: center;
            position: relative;
            z-index: 1001;
        }
        .guide-title {
            font-size: 28px;
            color: var(--orange);
            margin-bottom: 20px;
        }
        .guide-item {
            margin: 15px 0;
            text-align: left;
            font-size: 16px;
        }
        /* é¦–é¡µ */
        #game-home {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 95%;
            max-width: 420px;
            background: white;
            padding: 30px 20px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(211, 84, 0, 0.2);
            border: 4px solid var(--gold);
            text-align: center;
            margin: 20px auto;
        }
        .home-title {
            font-size: 36px;
            color: var(--orange);
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .year-theme {
            color: var(--red);
            font-size: 20px;
            margin-bottom: 20px;
        }
        /* é€‰é¡¹ç»„ */
        .option-group {
            margin: 15px 0;
            width: 100%;
        }
        .option-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        /* éš¾åº¦/æ“æ§é€‰æ‹© */
        .mode-options {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .mode-btn {
            padding: 8px 18px;
            font-size: 16px;
            margin: 0;
            border-radius: 50px;
            border: 2px solid #eee;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .mode-btn.active {
            background: var(--orange);
            color: white;
            border-color: var(--orange);
            box-shadow: 0 4px 8px rgba(230, 126, 34, 0.2);
        }
        /* çš®è‚¤é€‰æ‹© */
        .skin-options {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .skin-btn {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            border: 3px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            overflow: hidden;
            position: relative;
        }
        .skin-btn.active {
            border-color: var(--orange);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(230, 126, 34, 0.3);
        }
        /* è‡ªå®šä¹‰çš®è‚¤æŒ‰é’®æ ·å¼ */
        .custom-skin-btn {
            flex-direction: column;
            font-size: 14px;
            padding: 5px;
        }
        .custom-skin-btn input {
            display: none;
        }
        .custom-skin-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        /* è‡ªå®šä¹‰çš®è‚¤å¼¹çª— */
        #custom-skin-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border: 3px solid var(--gold);
            z-index: 1001;
            display: none;
            width: 90%;
            max-width: 450px;
        }
        .modal-title {
            font-size: 22px;
            color: var(--orange);
            margin-bottom: 20px;
            text-align: center;
        }
        .skin-upload-group {
            margin: 15px 0;
        }
        .upload-label {
            display: block;
            padding: 10px;
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        .upload-label:hover {
            background: #f0f0f0;
            border-color: var(--gold);
        }
        .upload-tip {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }
        /* é¢„è§ˆå®¹å™¨ */
        .preview-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .preview-item {
            text-align: center;
            flex: 1;
            min-width: 80px;
            max-width: 100px;
        }
        .preview-box {
            width: 80px;
            height: 80px;
            border: 2px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 5px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            display: block;
        }
        .modal-btn-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        /* é¡¶éƒ¨ä¿¡æ¯æ  */
        .header { 
            width: 95%; 
            max-width: 420px; 
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between; 
            padding: 15px 5px; 
            margin: 0 auto;
            position: relative;
            gap: 10px;
        }
        .stat-box { 
            background: white; 
            padding: 5px 15px; 
            border-radius: 50px; 
            border: 2px solid var(--gold); 
            font-weight: bold; 
            flex-shrink: 0;
        }
        /* æ¸¸æˆæ§åˆ¶æŒ‰é’® */
        .game-controls {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        .game-controls .btn {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        /* è¿å‡»æç¤ºç‰¹æ•ˆ */
        #combo-tip {
            position: absolute; 
            top: 40%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            color: var(--red); 
            font-size: 40px; 
            font-weight: 900; 
            pointer-events: none;
            opacity: 0; 
            transition: all 0.3s; 
            text-shadow: 2px 2px 0 white; 
            z-index: 100;
        }
        /* æ¸¸æˆå®¹å™¨ä¸é˜´å½± */
        #game-wrapper {
            width: 95%; 
            max-width: 420px; 
            position: relative; 
            margin: 10px auto;
            background: white; 
            padding: 10px; 
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(211, 84, 0, 0.2); 
            border: 4px solid var(--gold);
            display: none;
        }
        canvas { 
            width: 100%; 
            display: block; 
            border-radius: 12px; 
            background: #fffcf5; 
            touch-action: none; /* å…³é”®ï¼šç¦ç”¨canvasé»˜è®¤è§¦æ‘¸è¡Œä¸º */
        }
        /* æ€»ç»“é¢æ¿ä¼˜åŒ– */
        .overlay {
            position: absolute; 
            inset: 0; 
            background: rgba(255,255,255,0.95);
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            z-index: 200; 
            border-radius: 16px; 
            padding: 20px; 
            text-align: center;
            overflow-y: auto;
        }
        .overlay::-webkit-scrollbar {
            width: 6px;
        }
        .overlay::-webkit-scrollbar-track {
            background: rgba(255,248,230,0.5);
        }
        .overlay::-webkit-scrollbar-thumb {
            background: var(--gold);
            border-radius: 3px;
        }
        .share-card { 
            background: white; 
            border: 2px dashed var(--gold); 
            padding: 15px; 
            border-radius: 15px; 
            margin-bottom: 15px; 
        }
        .route-summary-container { 
            width: 240px; 
            height: 160px; 
            background: #fef9ef; 
            border: 1px solid #ddd; 
            margin: 10px auto; 
        }
        /* æŒ‰é’®è®¾è®¡ */
        .btn-group { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
            justify-content: center; 
        }
        .btn {
            padding: 10px 20px; 
            border-radius: 50px; 
            border: none; 
            font-weight: bold;
            cursor: pointer; 
            transition: transform 0.1s; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            margin: 8px;
        }
        .btn-main { 
            background: var(--red); 
            color: white; 
        }
        .btn-sub { 
            background: var(--gold); 
            color: white; 
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--orange) 0%, #d35400 100%);
            color: white;
            padding: 12px 25px;
            font-size: 18px;
        }
        .btn:active { 
            transform: translateY(2px); 
            box-shadow: none; 
        }
        /* æš‚åœé¢æ¿ */
        #pause-panel {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            border-radius: 16px;
            padding: 20px;
        }
        .panel-title {
            font-size: 28px;
            color: var(--orange);
            margin-bottom: 20px;
        }
        /* æ’è¡Œæ¦œå¼¹çª— */
        #rank-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            padding: 30px 20px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 90%;
            max-width: 380px;
            z-index: 1001;
            border: 3px solid var(--gold);
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .rank-list {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
        }
        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            font-size: 16px;
        }
        .rank-num {
            color: var(--orange);
            font-weight: bold;
            width: 30px;
        }
        .rank-score {
            color: #2c3e50;
            font-weight: bold;
        }
        .rank-date {
            color: #7f8c8d;
            font-size: 14px;
        }
        /* é®ç½©å±‚ */
        #mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        /* åŠ è½½æç¤ºæ ·å¼ */
        #upload-tip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 8px;
            font-size: 16px;
            z-index: 9999;
            display: none;
        }
        
        /* æ»‘åŠ¨æ“æ§åœ†ç›˜æ ·å¼ - ä¼˜åŒ–ç‰ˆ */
        #joystick-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 200px;
            display: none;
            z-index: 90;
            pointer-events: auto;
        }
        
        /* æ“æ§ç›˜èƒŒæ™¯ - ä¼˜åŒ–ç‰ˆ */
        .joystick-bg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            border: 3px solid var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            touch-action: none;
            pointer-events: auto;
        }
        
        /* æ“æ§ç›˜æ‘‡æ† - ä¼˜åŒ–ç‰ˆï¼ˆè·Ÿéšæ‰‹æŒ‡ç§»åŠ¨ï¼‰ */
        .joystick-knob {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--gold);
            position: absolute;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.05s ease-out; /* é¡ºæ»‘è·Ÿéš */
            touch-action: none;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        
        /* æ–¹å‘æŒ‡ç¤º */
        .joystick-direction {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        
        .direction-btn {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--gold);
        }
        
        .up { top: 10px; }
        .down { bottom: 10px; }
        .left { left: 10px; }
        .right { right: 10px; }
        
        /* ç”µè„‘ç«¯ä¼˜åŒ– */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            #game-home, #game-wrapper {
                max-width: 500px;
            }
            .header {
                max-width: 500px;
            }
        }
        /* æ‰‹æœºç«¯ä¼˜åŒ– */
        @media (max-width: 767px) {
            #ai-toggle {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            .audio-controls {
                top: 10px;
                right: 10px;
            }
            .audio-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            #game-home, #game-wrapper {
                width: 100%;
                margin: 10px auto;
            }
            .home-title {
                font-size: 30px;
            }
            .preview-container {
                flex-direction: row;
                gap: 10px;
            }
            .preview-item {
                min-width: 70px;
                max-width: 80px;
            }
            .preview-box {
                width: 70px;
                height: 70px;
            }
            .header {
                justify-content: center;
            }
            .stat-box {
                font-size: 14px;
                padding: 5px 10px;
            }
            
            /* ç§»åŠ¨ç«¯æ“æ§ç›˜é€‚é… */
            #joystick-container {
                width: 180px;
                height: 180px;
                bottom: 20px;
            }
            .joystick-knob {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <!-- é®ç½©å±‚ -->
    <div id="mask"></div>
    <!-- AI å¼€å…³ -->
    <div id="ai-toggle" title="AI æœ€çŸ­è·¯å¾„è§„åˆ’">ğŸ§ </div>
    <!-- éŸ³æ•ˆ/éŸ³ä¹æ§åˆ¶ -->
    <div class="audio-controls">
        <div class="audio-btn" id="music-btn" title="èƒŒæ™¯éŸ³ä¹">ğŸµ</div>
        <div class="audio-btn" id="sound-btn" title="æ¸¸æˆéŸ³æ•ˆ">ğŸ”Š</div>
    </div>
    <!-- æ¸¸æˆå¼•å¯¼é¡µ -->
    <div id="guide-page">
        <div class="guide-content">
            <h2 class="guide-title">ğŸ 2026é©¬å¹´æ–°æ˜¥è´ªåƒè›‡</h2>
            
            <div class="guide-item">
                <strong>ğŸ® æ“æ§æ–¹å¼ï¼š</strong><br>
                â€¢ ç”µè„‘ï¼šæ–¹å‘é”®æ§åˆ¶è›‡çš„ç§»åŠ¨<br>
                â€¢ æ‰‹æœºï¼šæ»‘åŠ¨æ“æ§ç›˜ï¼ˆæ‘‡æ†è·Ÿéšæ‰‹æŒ‡ç§»åŠ¨ï¼‰æ§åˆ¶æ–¹å‘
            </div>
            
            <div class="guide-item">
                <strong>ğŸ§  AI æœ€çŸ­è·¯å¾„ï¼š</strong><br>
                â€¢ ç‚¹å‡»å·¦ä¸Šè§’ ğŸ§  å¼€å¯/å…³é—­ AI è‡ªåŠ¨å¯»è·¯<br>
                â€¢ AI ä¼šè‡ªåŠ¨è§„åˆ’æœ€çŸ­è·¯å¾„å»åƒè‹¹æœ
            </div>
            
            <div class="guide-item">
                <strong>ğŸ å¾—åˆ†è§„åˆ™ï¼š</strong><br>
                â€¢ åƒåˆ°è‹¹æœ+10åˆ†ï¼Œè¿å‡»åˆ†æ•°ç¿»å€<br>
                â€¢ è›‡è¶Šé•¿ï¼Œéš¾åº¦è¶Šé«˜
            </div>
            
            <div class="guide-item">
                <strong>âš ï¸ æ¸¸æˆç»“æŸï¼š</strong><br>
                â€¢ æ’åˆ°å¢™å£æˆ–è‡ªå·±èº«ä½“
            </div>
            
            <div class="guide-item">
                <strong>ğŸ¨ çš®è‚¤æ›´æ¢ï¼š</strong><br>
                â€¢ æ”¯æŒé¢„è®¾çš®è‚¤å’Œè‡ªå®šä¹‰ä¸Šä¼ å›¾ç‰‡ä½œä¸ºè›‡å¤´ã€è›‡èº«ã€è›‡å°¾çš®è‚¤<br>
                â€¢ è‡ªå®šä¹‰çš®è‚¤ä¼šåº”ç”¨åˆ°æ¸¸æˆè¿‡ç¨‹ä¸­çš„æ¯ä¸€èŠ‚èº«ä½“
            </div>
            
            <div class="guide-item">
                <strong>ğŸ† æ’è¡Œæ¦œï¼š</strong><br>
                â€¢ è‡ªåŠ¨è®°å½•ä½ çš„æœ€é«˜åˆ†æ•°
            </div>
            
            <div class="guide-item">
                <strong>ğŸ“Š æˆ˜æŠ¥æ€»ç»“ï¼š</strong><br>
                â€¢ æ¸¸æˆç»“æŸåå¯æŸ¥çœ‹æ–°æ˜¥æˆ˜æŠ¥å’Œè·¯çº¿è½¨è¿¹
            </div>
            
            <button class="btn btn-primary" onclick="closeGuide()">å¼€å§‹æ¸¸æˆ</button>
        </div>
    </div>
    <!-- è‡ªå®šä¹‰çš®è‚¤å¼¹çª— -->
    <div id="custom-skin-modal">
        <h3 class="modal-title">ğŸ¨ è‡ªå®šä¹‰è›‡çš®è‚¤</h3>
        <!-- è›‡å¤´ä¸Šä¼  -->
        <div class="skin-upload-group">
            <label class="upload-label" for="head-upload">
                ğŸ ç‚¹å‡»ä¸Šä¼ è›‡å¤´å›¾ç‰‡
            </label>
            <input type="file" id="head-upload" accept="image/*">
            <p class="upload-tip">æ”¯æŒJPG/PNGæ ¼å¼ï¼Œå»ºè®®60x60æ­£æ–¹å½¢å›¾ç‰‡ï¼ˆé€æ˜èƒŒæ™¯æ›´ä½³ï¼‰</p>
        </div>
        <!-- è›‡èº«ä¸Šä¼  -->
        <div class="skin-upload-group">
            <label class="upload-label" for="body-upload">
                ğŸ“ ç‚¹å‡»ä¸Šä¼ è›‡èº«å›¾ç‰‡
            </label>
            <input type="file" id="body-upload" accept="image/*">
            <p class="upload-tip">æ”¯æŒJPG/PNGæ ¼å¼ï¼Œå»ºè®®60x60æ­£æ–¹å½¢å›¾ç‰‡ï¼ˆé€æ˜èƒŒæ™¯æ›´ä½³ï¼‰</p>
        </div>
        <!-- è›‡å°¾ä¸Šä¼  -->
        <div class="skin-upload-group">
            <label class="upload-label" for="tail-upload">
                ğŸŒ€ ç‚¹å‡»ä¸Šä¼ è›‡å°¾å›¾ç‰‡
            </label>
            <input type="file" id="tail-upload" accept="image/*">
            <p class="upload-tip">æ”¯æŒJPG/PNGæ ¼å¼ï¼Œå»ºè®®60x60æ­£æ–¹å½¢å›¾ç‰‡ï¼ˆé€æ˜èƒŒæ™¯æ›´ä½³ï¼‰</p>
        </div>
        <!-- é¢„è§ˆå®¹å™¨ -->
        <div class="preview-container">
            <div class="preview-item">
                <div class="preview-box" id="head-preview">
                    <span>è›‡å¤´é¢„è§ˆ</span>
                </div>
                <p>è›‡å¤´</p>
            </div>
            <div class="preview-item">
                <div class="preview-box" id="body-preview">
                    <span>è›‡èº«é¢„è§ˆ</span>
                </div>
                <p>è›‡èº«</p>
            </div>
            <div class="preview-item">
                <div class="preview-box" id="tail-preview">
                    <span>è›‡å°¾é¢„è§ˆ</span>
                </div>
                <p>è›‡å°¾</p>
            </div>
        </div>
        <div class="modal-btn-group">
            <button class="btn btn-sub" onclick="cancelCustomSkin()">å–æ¶ˆ</button>
            <button class="btn btn-main" onclick="confirmCustomSkin()">ç¡®è®¤ä½¿ç”¨</button>
        </div>
    </div>
    <!-- é¦–é¡µ -->
    <div id="game-home">
        <h1 class="home-title">æˆ‘æ˜¯è´ªåƒè›‡ ğŸ</h1>
        <div class="year-theme">ğŸ´ 2026é©¬å¹´æ–°æ˜¥ç‰ˆ ğŸ§§</div>
        <!-- æ“æ§æ–¹å¼ -->
        <div class="option-group">
            <div class="option-title" style="display: flex; align-items: center; gap: 8px;">
                <span>ğŸ®</span> æ“æ§æ–¹å¼
            </div>
            <div class="mode-options">
                <button class="mode-btn active" data-control="keyboard">é”®ç›˜æ“æ§</button>
                <button class="mode-btn" data-control="swipe">æ»‘åŠ¨æ“æ§</button>
            </div>
        </div>
        <!-- éš¾åº¦é€‰æ‹© -->
        <div class="option-group">
            <div class="option-title" style="display: flex; align-items: center; gap: 8px; margin-top: 15px;">
                <span>ğŸ¢</span> æ¸¸æˆéš¾åº¦
            </div>
            <div class="mode-options">
                <button class="mode-btn active" data-speed="200">ç®€å•</button>
                <button class="mode-btn" data-speed="150">ä¸­ç­‰</button>
                <button class="mode-btn" data-speed="120">å›°éš¾</button>
            </div>
        </div>
        <!-- çš®è‚¤é€‰æ‹© -->
        <div class="option-group">
            <div class="option-title">ğŸ¨ è›‡è›‡çš®è‚¤</div>
            <div class="skin-options">
                <div class="skin-btn active" data-skin="year" title="é©¬å¹´ä¸»é¢˜">ğŸ´</div>
                <div class="skin-btn" data-skin="red" title="ä¸­å›½çº¢">ğŸ”´</div>
                <div class="skin-btn" data-skin="gold" title="é»„é‡‘">ğŸŸ¡</div>
                <div class="skin-btn" data-skin="green" title="ç¿¡ç¿ ">ğŸŸ¢</div>
                <div class="skin-btn" data-skin="blue" title="å®çŸ³">ğŸ”µ</div>
                <div class="skin-btn custom-skin-btn" id="custom-skin-btn" title="è‡ªå®šä¹‰çš®è‚¤">
                    ğŸ“·<br>è‡ªå®šä¹‰
                </div>
            </div>
        </div>
        <!-- åŠŸèƒ½æŒ‰é’® -->
        <button class="btn btn-primary" id="start-btn">å¼€å§‹æ¸¸æˆ ğŸ®</button>
        <button class="btn btn-sub" onclick="showRank()">æŸ¥çœ‹æ’è¡Œæ¦œ ğŸ†</button>
    </div>
    <!-- æ¸¸æˆç•Œé¢ -->
    <div class="header" id="game-header" style="display: none;">
        <div class="stat-box">å¾—åˆ†: <span id="score">0</span></div>
        <div class="stat-box" id="combo-ui">Combo x1</div>
        <div class="stat-box">æœ€é«˜: <span id="high-score">0</span></div>
        <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
        <div class="game-controls">
            <button class="btn btn-sub" id="pause-btn" title="æš‚åœæ¸¸æˆ">â¸ï¸</button>
            <button class="btn btn-main" id="home-btn" title="è¿”å›ä¸»é¡µ">ğŸ </button>
        </div>
    </div>
    <div id="game-wrapper">
        <div id="combo-tip">COMBO!</div>
        <canvas id="game-canvas"></canvas>
        <!-- æš‚åœé¢æ¿ -->
        <div id="pause-panel">
            <h2 class="panel-title">æ¸¸æˆæš‚åœ â¸ï¸</h2>
            <button class="btn btn-main" onclick="togglePause()">ç»§ç»­æ¸¸æˆ</button>
            <button class="btn btn-sub" onclick="backToHome()">è¿”å›é¦–é¡µ</button>
        </div>
        <!-- ç»“æŸé¢æ¿ -->
        <div id="over-panel" class="overlay">
            <h2 style="color: var(--red); margin-bottom: 10px;">ğŸ§§ é©¬åˆ°æˆåŠŸ Â· æˆ˜æŠ¥</h2>
            <div class="share-card">
                <div id="achievement-title" style="font-weight: bold; color: #d35400;">[ ä¸›æ—èŒè›‡ ]</div>
                <div class="route-summary-container">
                    <canvas id="route-summary-map"></canvas>
                </div>
                <p style="font-size: 12px; color: #666;">
                    æ­¥æ•°: <span id="res-steps">0</span> | 
                    è‹¹æœ: <span id="res-apples">0</span> | 
                    éš¾åº¦: <span id="res-difficulty">ç®€å•</span>
                </p>
            </div>
            <div class="btn-group">
                <button class="btn btn-main" onclick="restartGame()">å†åˆ›è¾‰ç…Œ</button>
                <button class="btn btn-sub" onclick="saveAsImage()">åˆ†äº«æˆ˜ç»©</button>
                <button class="btn btn-sub" onclick="backToHome()">è¿”å›é¦–é¡µ</button>
            </div>
        </div>
    </div>
    
    <!-- æ»‘åŠ¨æ“æ§åœ†ç›˜ -->
    <div id="joystick-container">
        <div class="joystick-bg" id="joystick-bg">
            <div class="joystick-knob" id="joystick-knob"></div>
            <div class="joystick-direction">
                <div class="direction-btn up">â†‘</div>
                <div class="direction-btn down">â†“</div>
                <div class="direction-btn left">â†</div>
                <div class="direction-btn right">â†’</div>
            </div>
        </div>
    </div>
    
    <!-- æ’è¡Œæ¦œå¼¹çª— -->
    <div id="rank-modal">
        <h2 class="panel-title">ğŸ† æ–°æ˜¥æ’è¡Œæ¦œ</h2>
        <div class="rank-list" id="rank-list">
            <!-- æ’è¡Œæ¦œå†…å®¹åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <button class="btn btn-sub" onclick="closeRank()">å…³é—­</button>
    </div>
    <!-- éŸ³é¢‘èµ„æº -->
    <audio id="bg-music" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-joyful-festival-1369.mp3" type="audio/mpeg">
    </audio>
    <audio id="eat-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" type="audio/mpeg">
    </audio>
    <audio id="hit-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ========== æ ¸å¿ƒé…ç½® ==========
        const config = {
            control: "keyboard",
            speed: 200,
            skin: "year",
            gridSize: 20,
            musicOn: true,
            soundOn: true,
            aiEnabled: false,
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            customSkin: {
                enabled: false,
                headImg: null,      
                bodyImg: null,      
                tailImg: null,      
                headImgUrl: "",     
                bodyImgUrl: "",     
                tailImgUrl: "",     
                headLoaded: false,  
                bodyLoaded: false,
                tailLoaded: false,  
                forceApply: false
            },
            colors: {
                year: { head: "#e67e22", body: "#f39c12", eye: "#fff", bg: "#fff8e6" },
                red: { head: "#e74c3c", body: "#c0392b", eye: "#fff", bg: "#ffebee" },
                gold: { head: "#f1c40f", body: "#f39c12", eye: "#000", bg: "#fff9c4" },
                green: { head: "#2ecc71", body: "#27ae60", eye: "#fff", bg: "#e8f5e9" },
                blue: { head: "#3498db", body: "#2980b9", eye: "#fff", bg: "#e3f2fd" }
            },
            dx: 0,
            dy: -1
        };

        // çš®è‚¤åŠ è½½çŠ¶æ€å…¨å±€å˜é‡
        let skinLoadState = {
            isCustomSelected: false, 
            isAllLoaded: false,      
            loadTip: ""              
        };

        // æ»‘åŠ¨æ§åˆ¶æ ¸å¿ƒå˜é‡
        let touchStartX = 0;
        let touchStartY = 0;
        const SWIPE_THRESHOLD = 15; // æ»‘åŠ¨è§¦å‘é˜ˆå€¼

        // æ¸¸æˆæ ¸å¿ƒå˜é‡
        let canvas, ctx;
        let snake = [];
        let food = {};
        let dx = 0;
        let dy = -1;
        let score = 0;
        let highest = 0;
        let gameLoop = null;
        let isPaused = false;
        let isGameOver = false;
        let rankData = [];
        let combo = 1;
        let comboSteps = 0;
        let moveRoute = [];
        let appleCount = 0;
        let gameStartTime = 0;
        
        // æ»‘åŠ¨æ“æ§åœ†ç›˜å˜é‡ - ä¼˜åŒ–ç‰ˆï¼ˆæ”¯æŒè·Ÿéšæ‰‹æŒ‡ç§»åŠ¨ï¼‰
        let joystick = {
            isActive: false,
            centerX: 0,
            centerY: 0,
            maxDistance: 70,
            knob: null,
            bg: null,
            container: null,
            startX: 0, // è§¦æ‘¸èµ·å§‹X
            startY: 0  // è§¦æ‘¸èµ·å§‹Y
        };
        
        // DOMå…ƒç´ ç¼“å­˜
        const dom = {
            gameHome: document.getElementById("game-home"),
            gameHeader: document.getElementById("game-header"),
            gameWrapper: document.getElementById("game-wrapper"),
            canvas: document.getElementById("game-canvas"),
            overPanel: document.getElementById("over-panel"),
            pausePanel: document.getElementById("pause-panel"),
            customSkinModal: document.getElementById("custom-skin-modal"),
            customSkinBtn: document.getElementById("custom-skin-btn"),
            headUpload: document.getElementById("head-upload"),
            bodyUpload: document.getElementById("body-upload"),
            tailUpload: document.getElementById("tail-upload"),
            headPreview: document.getElementById("head-preview"),
            bodyPreview: document.getElementById("body-preview"),
            tailPreview: document.getElementById("tail-preview"),
            mask: document.getElementById("mask"),
            audio: {
                bgMusic: document.getElementById("bg-music"),
                eatSound: document.getElementById("eat-sound"),
                hitSound: document.getElementById("hit-sound")
            },
            // æ“æ§ç›˜å…ƒç´ 
            joystickContainer: document.getElementById("joystick-container"),
            joystickBg: document.getElementById("joystick-bg"),
            joystickKnob: document.getElementById("joystick-knob"),
        };

        // ========== åˆå§‹åŒ– ==========
        window.onload = function() {
            if (config.isMobile) {
                document.querySelector('[data-control="swipe"]').click();
            }
            initCanvas();
            initSummaryCanvas();
            loadHighestScore();
            loadRankData();
            bindAllEvents();
            bindCustomSkinEvents();
            bindModalCloseEvents();
            playBgMusic();
            initSwipeControl(); // åˆå§‹åŒ–æ»‘åŠ¨æ§åˆ¶
            initGameData();
            drawGame();
            
            // åˆå§‹åŒ–æ»‘åŠ¨æ“æ§åœ†ç›˜ - ä¼˜åŒ–ç‰ˆï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰
            initJoystick();
            
            // ç›‘å¬æ“æ§æ¨¡å¼åˆ‡æ¢
            document.querySelectorAll(".mode-btn[data-control]").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const siblings = Array.from(btn.parentElement.children);
                    siblings.forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    if (btn.dataset.control) config.control = btn.dataset.control;
                    updateJoystickVisibility();
                    updateJoystickColor();
                    // åˆ‡æ¢æ¨¡å¼åé‡ç½®æ‘‡æ†
                    setTimeout(resetJoystick, 100);
                });
            });
            
            // åˆå§‹åŒ–å¼€å§‹æ¸¸æˆæŒ‰é’®çŠ¶æ€
            updateSkinLoadState();
            updateStartBtnState();
            
            window.addEventListener('resize', () => {
                if (!isGameOver) {
                    resizeCanvas();
                    drawGame();
                    // è°ƒæ•´æ“æ§ç›˜ä½ç½®
                    if (joystick.container && joystick.container.style.display === "block") {
                        resetJoystick();
                    }
                }
            });
        };

        // ========== æ»‘åŠ¨æ“æ§æ ¸å¿ƒé€»è¾‘ ==========
        function initSwipeControl() {
            const gameCanvas = document.getElementById("game-canvas");

            // è§¦æ‘¸å¼€å§‹
            gameCanvas.addEventListener("touchstart", (e) => {
                e.preventDefault();
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: false });

            // è§¦æ‘¸ç§»åŠ¨ï¼ˆæ ¸å¿ƒï¼šåˆ¤æ–­æ»‘åŠ¨æ–¹å‘ï¼‰
            gameCanvas.addEventListener("touchmove", (e) => {
                e.preventDefault();
                const touchX = e.touches[0].clientX;
                const touchY = e.touches[0].clientY;

                const deltaX = touchX - touchStartX;
                const deltaY = touchY - touchStartY;

                // åˆ¤æ–­æ»‘åŠ¨æ–¹å‘
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    // æ°´å¹³æ»‘åŠ¨
                    if (deltaX > SWIPE_THRESHOLD && dx !== -1) {
                        dx = 1;
                        dy = 0;
                        touchStartX = touchX; // é‡ç½®èµ·ç‚¹ï¼Œé¿å…è¿ç»­è§¦å‘
                    } else if (deltaX < -SWIPE_THRESHOLD && dx !== 1) {
                        dx = -1;
                        dy = 0;
                        touchStartX = touchX;
                    }
                } else {
                    // å‚ç›´æ»‘åŠ¨
                    if (deltaY > SWIPE_THRESHOLD && dy !== -1) {
                        dx = 0;
                        dy = 1;
                        touchStartY = touchY;
                    } else if (deltaY < -SWIPE_THRESHOLD && dy !== 1) {
                        dx = 0;
                        dy = -1;
                        touchStartY = touchY;
                    }
                }
            }, { passive: false });

            // è§¦æ‘¸ç»“æŸ
            gameCanvas.addEventListener("touchend", (e) => {
                e.preventDefault();
            }, { passive: false });

            // é˜²æ­¢è§¦æ‘¸è¢«æµè§ˆå™¨æ‹¦æˆª
            gameCanvas.addEventListener("touchcancel", (e) => {
                e.preventDefault();
            }, { passive: false });
        }

        // ========== æ»‘åŠ¨æ“æ§åœ†ç›˜æ ¸å¿ƒé€»è¾‘ï¼ˆä¼˜åŒ–ç‰ˆ - æ”¯æŒè·Ÿéšæ‰‹æŒ‡ç§»åŠ¨ï¼‰ ==========
        function initJoystick() {
            // ç¡®ä¿DOMå…ƒç´ åŠ è½½å®Œæˆ
            if (!dom.joystickContainer || !dom.joystickBg || !dom.joystickKnob) {
                setTimeout(initJoystick, 100);
                return;
            }
            
            joystick.container = dom.joystickContainer;
            joystick.bg = dom.joystickBg;
            joystick.knob = dom.joystickKnob;
            
            // åˆå§‹åŒ–ä½ç½®
            resetJoystick();
            
            // ç»‘å®šè§¦æ‘¸äº‹ä»¶ï¼ˆä¼˜åŒ–ç‰ˆï¼šæ”¯æŒè·Ÿéšæ‰‹æŒ‡ç§»åŠ¨ï¼‰
            bindJoystickEventsOptimized();
            
            // åˆå§‹æ›´æ–°æ˜¾ç¤ºçŠ¶æ€å’Œé¢œè‰²
            updateJoystickVisibility();
            updateJoystickColor();
        }

        // é‡ç½®æ‘‡æ†ä½ç½®ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        function resetJoystick() {
            if (!joystick.bg || !joystick.knob) return;
            
            // è·å–èƒŒæ™¯ä¸­å¿ƒä½ç½®
            const rect = joystick.bg.getBoundingClientRect();
            joystick.centerX = rect.left + rect.width / 2;
            joystick.centerY = rect.top + rect.height / 2;
            joystick.maxDistance = Math.min(rect.width, rect.height) / 2 - 35;
            
            // é‡ç½®æ‘‡æ†åˆ°ä¸­å¿ƒ
            joystick.knob.style.transform = `translate(-50%, -50%)`;
            joystick.isActive = false;
        }

        // æ›´æ–°æ“æ§ç›˜æ˜¾ç¤º/éšè—ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        function updateJoystickVisibility() {
            if (config.control === "swipe" && dom.gameWrapper.style.display === "block") {
                dom.joystickContainer.style.display = "block";
                // ç¡®ä¿canvasæ»‘åŠ¨äº‹ä»¶å’Œæ‘‡æ†äº‹ä»¶ä¸å†²çª
                dom.canvas.style.touchAction = "none";
                setTimeout(resetJoystick, 50); // å»¶è¿Ÿé‡ç½®ç¡®ä¿DOMå·²æ¸²æŸ“
            } else {
                dom.joystickContainer.style.display = "none";
            }
        }

        // æ›´æ–°æ“æ§ç›˜é¢œè‰²ï¼ˆéšçš®è‚¤å˜åŒ–ï¼‰
        function updateJoystickColor() {
            if (!joystick.bg || !joystick.knob) return;
            
            let skinColor = config.colors[config.skin];
            if (config.skin === "custom" && config.customSkin.enabled) {
                // è‡ªå®šä¹‰çš®è‚¤æ—¶ä½¿ç”¨é»˜è®¤é‡‘è‰²
                skinColor = { head: "#f39c12", body: "#f39c12" };
            }
            
            // æ›´æ–°CSSå˜é‡
            document.documentElement.style.setProperty('--gold', skinColor.head);
            
            // æ›´æ–°æ“æ§ç›˜æ ·å¼
            joystick.bg.style.borderColor = skinColor.head;
            joystick.knob.style.background = skinColor.head;
            
            // æ›´æ–°æ–¹å‘æŒ‰é’®é¢œè‰²
            const directionBtns = document.querySelectorAll('.direction-btn');
            directionBtns.forEach(btn => {
                btn.style.color = skinColor.head;
            });
        }

        // ç»‘å®šæ‘‡æ†è§¦æ‘¸äº‹ä»¶ï¼ˆä¼˜åŒ–ç‰ˆ - æ ¸å¿ƒï¼šè·Ÿéšæ‰‹æŒ‡ç§»åŠ¨ï¼‰
        function bindJoystickEventsOptimized() {
            const knob = joystick.knob;
            const bg = joystick.bg;
            
            // è§¦æ‘¸å¼€å§‹
            bg.addEventListener("touchstart", (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // æ¿€æ´»æ‘‡æ†
                joystick.isActive = true;
                
                // è®°å½•è§¦æ‘¸èµ·å§‹ä½ç½®
                const touch = e.touches[0];
                joystick.startX = touch.clientX;
                joystick.startY = touch.clientY;
                
                // é‡æ–°è®¡ç®—èƒŒæ™¯ä¸­å¿ƒï¼ˆé˜²æ­¢é¡µé¢æ»šåŠ¨å¯¼è‡´ä½ç½®åç§»ï¼‰
                const rect = bg.getBoundingClientRect();
                joystick.centerX = rect.left + rect.width / 2;
                joystick.centerY = rect.top + rect.height / 2;
                
            }, { passive: false });
            
            // è§¦æ‘¸ç§»åŠ¨ï¼ˆæ ¸å¿ƒï¼šè·Ÿéšæ‰‹æŒ‡ç§»åŠ¨ï¼‰
            document.addEventListener("touchmove", (e) => {
                if (!joystick.isActive || isGameOver || isPaused) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                const touch = e.touches[0];
                const touchX = touch.clientX;
                const touchY = touch.clientY;
                
                // è®¡ç®—æ‰‹æŒ‡ç›¸å¯¹äºèƒŒæ™¯ä¸­å¿ƒçš„åç§»é‡
                const deltaX = touchX - joystick.centerX;
                const deltaY = touchY - joystick.centerY;
                
                // è®¡ç®—åç§»è·ç¦»å’Œè§’åº¦
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
                
                // é™åˆ¶æœ€å¤§ç§»åŠ¨è·ç¦»ï¼ˆé¿å…è¶…å‡ºèƒŒæ™¯ï¼‰
                let finalX = deltaX;
                let finalY = deltaY;
                
                if (distance > joystick.maxDistance) {
                    // æŒ‰æ¯”ä¾‹ç¼©å°åç§»é‡ï¼Œä¿æŒæ–¹å‘ä¸å˜
                    finalX = (deltaX / distance) * joystick.maxDistance;
                    finalY = (deltaY / distance) * joystick.maxDistance;
                }
                
                // å®æ—¶æ›´æ–°æ‘‡æ†ä½ç½®ï¼ˆæ ¸å¿ƒï¼šè·Ÿéšæ‰‹æŒ‡ç§»åŠ¨ï¼‰
                knob.style.transform = `translate(-50%, -50%) translate(${finalX}px, ${finalY}px)`;
                
                // æ ¹æ®è§’åº¦è®¾ç½®è›‡çš„ç§»åŠ¨æ–¹å‘
                setDirectionByAngleOptimized(angle);
                
            }, { passive: false });
            
            // è§¦æ‘¸ç»“æŸ/å–æ¶ˆï¼šé‡ç½®æ‘‡æ†
            ["touchend", "touchcancel"].forEach(eventType => {
                document.addEventListener(eventType, (e) => {
                    if (joystick.isActive) {
                        e.preventDefault();
                        joystick.isActive = false;
                        // å¹³æ»‘é‡ç½®åˆ°ä¸­å¿ƒ
                        knob.style.transform = `translate(-50%, -50%)`;
                    }
                }, { passive: false });
            });
            
            // PCç«¯é¼ æ ‡æ”¯æŒï¼ˆæµ‹è¯•ç”¨ï¼‰
            bg.addEventListener("mousedown", (e) => {
                e.preventDefault();
                e.stopPropagation();
                joystick.isActive = true;
                const rect = bg.getBoundingClientRect();
                joystick.centerX = rect.left + rect.width / 2;
                joystick.centerY = rect.top + rect.height / 2;
            });
            
            document.addEventListener("mousemove", (e) => {
                if (!joystick.isActive || isGameOver || isPaused) return;
                
                e.preventDefault();
                const mouseX = e.clientX;
                const mouseY = e.clientY;
                
                const deltaX = mouseX - joystick.centerX;
                const deltaY = mouseY - joystick.centerY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
                
                let finalX = deltaX;
                let finalY = deltaY;
                
                if (distance > joystick.maxDistance) {
                    finalX = (deltaX / distance) * joystick.maxDistance;
                    finalY = (deltaY / distance) * joystick.maxDistance;
                }
                
                knob.style.transform = `translate(-50%, -50%) translate(${finalX}px, ${finalY}px)`;
                setDirectionByAngleOptimized(angle);
            });
            
            document.addEventListener("mouseup", () => {
                if (joystick.isActive) {
                    joystick.isActive = false;
                    knob.style.transform = `translate(-50%, -50%)`;
                }
            });
        }

        // æ ¹æ®è§’åº¦è®¾ç½®è›‡çš„ç§»åŠ¨æ–¹å‘ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        function setDirectionByAngleOptimized(angle) {
            let newDx = dx;
            let newDy = dy;
            
            // è§’åº¦æ˜ å°„ï¼šé€‚é…å±å¹•åæ ‡ç³»
            if (angle >= -135 && angle <= -45) {
                // ä¸Š
                newDx = 0;
                newDy = -1;
            } else if (angle >= 45 && angle <= 135) {
                // ä¸‹
                newDx = 0;
                newDy = 1;
            } else if ((angle > 135 && angle < 225) || (angle < -135 && angle > -225)) {
                // å·¦
                newDx = -1;
                newDy = 0;
            } else if ((angle > -45 && angle < 45)) {
                // å³
                newDx = 1;
                newDy = 0;
            }
            
            // é˜²æ­¢180åº¦æ‰å¤´
            if (!(dx === -newDx && dy === -newDy)) {
                dx = newDx;
                dy = newDy;
                config.dx = dx;
                config.dy = dy;
            }
        }

        // ========== å¼¹çª—å…³é—­äº‹ä»¶ç»‘å®š ==========
        function bindModalCloseEvents() {
            dom.mask.addEventListener("click", function() {
                dom.customSkinModal.style.display = "none";
                dom.rankModal.style.display = "none";
                dom.mask.style.display = "none";
            });
            const modalContents = [
                dom.customSkinModal,
                dom.rankModal,
                document.querySelector('.guide-content')
            ];
            modalContents.forEach(el => {
                if (el) {
                    el.addEventListener("click", function(e) {
                        e.stopPropagation();
                    });
                }
            });
        }

        // ========== Canvasåˆå§‹åŒ– ==========
        function initCanvas() {
            canvas = dom.canvas;
            ctx = canvas.getContext("2d");
            resizeCanvas();
        }

        function initSummaryCanvas() {
            const sCanvas = document.getElementById("route-summary-map");
            sCanvas.width = 240;
            sCanvas.height = 160;
        }

        function resizeCanvas() {
            const wrapper = document.getElementById("game-wrapper");
            const size = Math.min(wrapper.clientWidth - 20, 400);
            canvas.width = size;
            canvas.height = size;
        }

        // ========== äº‹ä»¶ç»‘å®š ==========
        function bindAllEvents() {
            document.getElementById("ai-toggle").addEventListener("click", toggleAI);
            document.getElementById("music-btn").addEventListener("click", toggleMusic);
            document.getElementById("sound-btn").addEventListener("click", toggleSound);
            document.querySelectorAll(".mode-btn").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const siblings = Array.from(btn.parentElement.children);
                    siblings.forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    if (btn.dataset.control) config.control = btn.dataset.control;
                    if (btn.dataset.speed) config.speed = parseInt(btn.dataset.speed);
                });
            });
            document.querySelectorAll(".skin-btn:not(#custom-skin-btn)").forEach(btn => {
                btn.addEventListener("click", () => {
                    config.customSkin.enabled = false;
                    config.customSkin.headLoaded = false;
                    config.customSkin.bodyLoaded = false;
                    config.customSkin.tailLoaded = false;
                    config.customSkin.forceApply = false;
                    document.querySelectorAll(".skin-btn").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    config.skin = btn.dataset.skin;
                    updateJoystickColor(); // æ›´æ–°æ“æ§ç›˜é¢œè‰²
                    if (!isGameOver) drawGame();
                });
            });
            document.getElementById("start-btn").addEventListener("click", startGame);
            document.addEventListener("keydown", handleKeydown);
            document.addEventListener("keydown", (e) => {
                if (e.key === " " && dom.gameWrapper.style.display !== "none" && !isGameOver) {
                    togglePause();
                }
            });
            document.getElementById("pause-btn").addEventListener("click", togglePause);
            document.getElementById("home-btn").addEventListener("click", backToHome);
            
            // ç›‘å¬æ“æ§æ¨¡å¼åˆ‡æ¢ - ä¼˜åŒ–ç‰ˆ
            document.querySelectorAll(".mode-btn[data-control]").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const siblings = Array.from(btn.parentElement.children);
                    siblings.forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    if (btn.dataset.control) config.control = btn.dataset.control;
                    updateJoystickVisibility();
                    updateJoystickColor();
                    // åˆ‡æ¢æ¨¡å¼åé‡ç½®æ‘‡æ†
                    setTimeout(resetJoystick, 100);
                });
            });
        }

        // ========== è‡ªå®šä¹‰çš®è‚¤äº‹ä»¶ ==========
        function bindCustomSkinEvents() {
            dom.customSkinBtn.addEventListener("click", () => {
                dom.mask.style.display = "block";
                dom.customSkinModal.style.display = "block";
            });

            // è›‡å¤´ä¸Šä¼ 
            dom.headUpload.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) {
                    config.customSkin.headLoaded = false;
                    updateSkinLoadState();
                    skinLoadState.loadTip = "æ­£åœ¨åŠ è½½è›‡å¤´å›¾ç‰‡...";
                    updateStartBtnState();
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.crossOrigin = "anonymous";
                        img.onload = function() {
                            config.customSkin.headImg = img;
                            config.customSkin.headImgUrl = e.target.result;
                            config.customSkin.headLoaded = true;
                            skinLoadState.loadTip = "è›‡å¤´å›¾ç‰‡åŠ è½½å®Œæˆï¼";
                            updateSkinLoadState();
                            updateStartBtnState();
                            dom.headPreview.innerHTML = "";
                            const imgEl = document.createElement("img");
                            imgEl.src = e.target.result;
                            imgEl.className = "preview-img";
                            dom.headPreview.appendChild(imgEl);
                            if (dom.gameWrapper.style.display === "block" && !isGameOver) {
                                drawGame();
                            }
                        };
                        img.onerror = function() {
                            alert("è›‡å¤´å›¾ç‰‡åŠ è½½å¤±è´¥ï¼");
                            config.customSkin.headLoaded = false;
                            skinLoadState.loadTip = "è›‡å¤´å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ ï¼";
                            updateSkinLoadState();
                            updateStartBtnState();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // è›‡èº«ä¸Šä¼ 
            dom.bodyUpload.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) {
                    config.customSkin.bodyLoaded = false;
                    updateSkinLoadState();
                    skinLoadState.loadTip = "æ­£åœ¨åŠ è½½è›‡èº«å›¾ç‰‡...";
                    updateStartBtnState();
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.crossOrigin = "anonymous";
                        img.onload = function() {
                            config.customSkin.bodyImg = img;
                            config.customSkin.bodyImgUrl = e.target.result;
                            config.customSkin.bodyLoaded = true;
                            skinLoadState.loadTip = "è›‡èº«å›¾ç‰‡åŠ è½½å®Œæˆï¼";
                            updateSkinLoadState();
                            updateStartBtnState();
                            dom.bodyPreview.innerHTML = "";
                            const imgEl = document.createElement("img");
                            imgEl.src = e.target.result;
                            imgEl.className = "preview-img";
                            dom.bodyPreview.appendChild(imgEl);
                            if (dom.gameWrapper.style.display === "block" && !isGameOver) {
                                drawGame();
                            }
                        };
                        img.onerror = function() {
                            alert("è›‡èº«å›¾ç‰‡åŠ è½½å¤±è´¥ï¼");
                            config.customSkin.bodyLoaded = false;
                            skinLoadState.loadTip = "è›‡èº«å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ ï¼";
                            updateSkinLoadState();
                            updateStartBtnState();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // è›‡å°¾ä¸Šä¼ äº‹ä»¶
            dom.tailUpload.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (file) {
                    config.customSkin.tailLoaded = false;
                    updateSkinLoadState();
                    skinLoadState.loadTip = "æ­£åœ¨åŠ è½½è›‡å°¾å›¾ç‰‡...";
                    updateStartBtnState();
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.crossOrigin = "anonymous";
                        img.onload = function() {
                            config.customSkin.tailImg = img;
                            config.customSkin.tailImgUrl = e.target.result;
                            config.customSkin.tailLoaded = true;
                            skinLoadState.loadTip = "è›‡å°¾å›¾ç‰‡åŠ è½½å®Œæˆï¼";
                            updateSkinLoadState();
                            updateStartBtnState();
                            dom.tailPreview.innerHTML = "";
                            const imgEl = document.createElement("img");
                            imgEl.src = e.target.result;
                            imgEl.className = "preview-img";
                            dom.tailPreview.appendChild(imgEl);
                            if (dom.gameWrapper.style.display === "block" && !isGameOver) {
                                drawGame();
                            }
                        };
                        img.onerror = function() {
                            alert("è›‡å°¾å›¾ç‰‡åŠ è½½å¤±è´¥ï¼");
                            config.customSkin.tailLoaded = false;
                            skinLoadState.loadTip = "è›‡å°¾å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ ï¼";
                            updateSkinLoadState();
                            updateStartBtnState();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // ========== çš®è‚¤åŠ è½½çŠ¶æ€ç®¡ç† ==========
        function updateSkinLoadState() {
            skinLoadState.isCustomSelected = dom.customSkinBtn.classList.contains("active");
            skinLoadState.isAllLoaded = config.customSkin.headLoaded && config.customSkin.bodyLoaded && config.customSkin.tailLoaded;
            
            if (!skinLoadState.isCustomSelected) {
                skinLoadState.isAllLoaded = true;
                skinLoadState.loadTip = "";
            } else if (skinLoadState.isCustomSelected && !skinLoadState.isAllLoaded) {
                skinLoadState.loadTip = skinLoadState.loadTip || "è¯·ç­‰å¾…æ‰€æœ‰çš®è‚¤å›¾ç‰‡åŠ è½½å®Œæˆ...";
            } else {
                skinLoadState.loadTip = "æ‰€æœ‰çš®è‚¤åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æ¸¸æˆï¼";
            }
        }

        function updateStartBtnState() {
            const startBtn = document.getElementById("start-btn");
            if (skinLoadState.isCustomSelected && !skinLoadState.isAllLoaded) {
                startBtn.disabled = true;
                startBtn.style.opacity = "0.6";
                startBtn.style.cursor = "not-allowed";
                startBtn.innerHTML = `â³ ${skinLoadState.loadTip}`;
            } else {
                startBtn.disabled = false;
                startBtn.style.opacity = "1";
                startBtn.style.cursor = "pointer";
                startBtn.innerHTML = "å¼€å§‹æ¸¸æˆ ğŸ®";
            }
        }

        // ========== å¼¹çª—æ§åˆ¶å‡½æ•° ==========
        function closeGuide() {
            document.getElementById("guide-page").style.display = "none";
        }

        function showRank() {
            dom.mask.style.display = "block";
            dom.rankModal.style.display = "flex";
            renderRank();
        }

        function closeRank() {
            dom.rankModal.style.display = "none";
            dom.mask.style.display = "none";
        }

        function cancelCustomSkin() {
            dom.mask.style.display = "none";
            dom.customSkinModal.style.display = "none";
            dom.headUpload.value = "";
            dom.bodyUpload.value = "";
            dom.tailUpload.value = "";
            dom.headPreview.innerHTML = "<span>è›‡å¤´é¢„è§ˆ</span>";
            dom.bodyPreview.innerHTML = "<span>è›‡èº«é¢„è§ˆ</span>";
            dom.tailPreview.innerHTML = "<span>è›‡å°¾é¢„è§ˆ</span>";
        }

        function confirmCustomSkin() {
            if (!config.customSkin.headLoaded || !config.customSkin.bodyLoaded || !config.customSkin.tailLoaded) {
                alert("è¯·ä¸Šä¼ å¹¶ç­‰å¾…æ‰€æœ‰å›¾ç‰‡ï¼ˆè›‡å¤´ã€è›‡èº«ã€è›‡å°¾ï¼‰åŠ è½½å®Œæˆï¼");
                return;
            }
            config.skin = "custom";
            config.customSkin.enabled = true;
            config.customSkin.forceApply = true;
            document.querySelectorAll(".skin-btn").forEach(b => b.classList.remove("active"));
            dom.customSkinBtn.classList.add("active");
            skinLoadState.isCustomSelected = true;
            skinLoadState.isAllLoaded = true;
            updateJoystickColor(); // æ›´æ–°æ“æ§ç›˜é¢œè‰²
            updateStartBtnState();
            cancelCustomSkin();
            if (dom.gameWrapper.style.display === "block" && !isGameOver) {
                drawGame();
            } else {
                initGameData();
                drawGame();
            }
        }

        // ========== å·¥å…·å‡½æ•° ==========
        function playSound(type) {
            if (!config.soundOn) return;
            const sound = dom.audio[type];
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥:", e));
            }
        }

        function playBgMusic() {
            if (config.musicOn) {
                dom.audio.bgMusic.play().catch(e => {
                    console.log("èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼Œå·²è‡ªåŠ¨å…³é—­éŸ³ä¹:", e);
                    config.musicOn = false;
                    const musicBtn = document.getElementById("music-btn");
                    musicBtn.style.background = "#e74c3c";
                    musicBtn.style.color = "white";
                });
            }
        }

        function toggleMusic() {
            config.musicOn = !config.musicOn;
            const btn = document.getElementById("music-btn");
            if (config.musicOn) {
                dom.audio.bgMusic.play();
                btn.style.background = "rgba(255,255,255,0.9)";
                btn.style.color = "#f39c12";
            } else {
                dom.audio.bgMusic.pause();
                btn.style.background = "#e74c3c";
                btn.style.color = "white";
            }
        }

        function toggleSound() {
            config.soundOn = !config.soundOn;
            const btn = document.getElementById("sound-btn");
            if (!config.soundOn) {
                btn.style.background = "#e74c3c";
                btn.style.color = "white";
            } else {
                btn.style.background = "rgba(255,255,255,0.9)";
                btn.style.color = "#f39c12";
            }
        }

        function toggleAI() {
            config.aiEnabled = !config.aiEnabled;
            const btn = document.getElementById("ai-toggle");
            if (config.aiEnabled) {
                btn.classList.add("ai-on");
            } else {
                btn.classList.remove("ai-on");
            }
        }

        // ========== æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ==========
        function initGameData() {
            const mid = Math.floor(config.gridSize / 2);
            snake = [
                { x: mid, y: mid },
                { x: mid, y: mid + 1 },
                { x: mid, y: mid + 2 }
            ];
            dx = 0;
            dy = -1;
            config.dx = dx;
            config.dy = dy;
            generateFood();
            score = 0;
            combo = 1;
            comboSteps = 0;
            moveRoute = [];
            appleCount = 0;
            isGameOver = false;
            isPaused = false;
            moveRoute.push({x: mid, y: mid, isApple: false});
            document.getElementById("score").innerText = "0";
            document.getElementById("combo-ui").innerText = "Combo x1";
            document.getElementById("high-score").innerText = highest;
            dom.overPanel.style.display = "none";
            dom.pausePanel.style.display = "none";
            resetJoystick(); // é‡ç½®æ‘‡æ†
        }
        
        function startGame() {
            if (skinLoadState.isCustomSelected && !skinLoadState.isAllLoaded) {
                alert(`æ— æ³•å¼€å§‹æ¸¸æˆï¼š${skinLoadState.loadTip}`);
                return;
            }
            
            dom.gameHome.style.display = "none";
            dom.gameHeader.style.display = "flex";
            dom.gameWrapper.style.display = "block";
            
            // æ›´æ–°æ“æ§ç›˜æ˜¾ç¤ºå’Œé¢œè‰²
            updateJoystickVisibility();
            updateJoystickColor();
            
            gameStartTime = new Date().getTime();
            initGameData();
            clearInterval(gameLoop);
            gameLoop = setInterval(updateGame, config.speed);
            resizeCanvas();
            requestAnimationFrame(drawGame);
        }
        
        function updateGame() {
            if (isPaused || isGameOver) return;
            
            if (config.aiEnabled) {
                const aiDirection = findShortestPath();
                if (aiDirection) {
                    dx = aiDirection.x;
                    dy = aiDirection.y;
                    config.dx = dx;
                    config.dy = dy;
                }
            }
            
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            comboSteps++;
            moveRoute.push({x: head.x, y: head.y, isApple: false});
            const isWallCollision = head.x < 0 || head.x >= config.gridSize || head.y < 0 || head.y >= config.gridSize;
            const isSelfCollision = snake.some((seg, index) => {
                return index > 0 && seg.x === head.x && seg.y === head.y;
            });

            // ç¢°æ’æ£€æµ‹ - æ¸¸æˆç»“æŸ
            if (isWallCollision || isSelfCollision) {
                gameOver();
                return;
            }

            // æ·»åŠ æ–°å¤´éƒ¨
            snake.unshift(head);

            // åƒåˆ°é£Ÿç‰©çš„é€»è¾‘
            if (head.x === food.x && head.y === food.y) {
                playSound('eat-sound');
                appleCount++;
                score += 10 * combo;
                comboSteps = 0;
                
                // è¿å‡»é€»è¾‘
                combo++;
                document.getElementById('combo-ui').innerText = `Combo x${combo}`;
                
                // è¿å‡»ç‰¹æ•ˆ
                const comboTip = document.getElementById('combo-tip');
                comboTip.style.opacity = '1';
                comboTip.style.transform = 'translate(-50%, -50%) scale(1.2)';
                setTimeout(() => {
                    comboTip.style.opacity = '0';
                    comboTip.style.transform = 'translate(-50%, -50%) scale(1)';
                }, 300);
                
                // è®°å½•é£Ÿç‰©ä½ç½®
                moveRoute[moveRoute.length - 1].isApple = true;
                
                // ç”Ÿæˆæ–°é£Ÿç‰©
                generateFood();
            } else {
                // æ²¡åƒåˆ°é£Ÿç‰©ï¼Œç§»é™¤å°¾éƒ¨
                snake.pop();
                
                // è¿å‡»é‡ç½®
                if (comboSteps > config.gridSize * 2) {
                    combo = 1;
                    comboSteps = 0;
                    document.getElementById('combo-ui').innerText = 'Combo x1';
                }
            }

            // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
            document.getElementById('score').innerText = score;
            
            // ç»˜åˆ¶æ¸¸æˆç”»é¢
            drawGame();
        }

        // ç”Ÿæˆé£Ÿç‰©
        function generateFood() {
            let newFood;
            do {
                newFood = {
                    x: Math.floor(Math.random() * config.gridSize),
                    y: Math.floor(Math.random() * config.gridSize)
                };
            } while (snake.some(seg => seg.x === newFood.x && seg.y === newFood.y));
            
            food = newFood;
        }

        // ç»˜åˆ¶æ¸¸æˆ
        function drawGame() {
            if (!canvas) return;
            
            const cellSize = canvas.width / config.gridSize;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = config.colors[config.skin]?.bg || '#fffcf5';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶é£Ÿç‰©
            ctx.fillStyle = '#e74c3c';
            ctx.beginPath();
            ctx.arc(
                food.x * cellSize + cellSize / 2,
                food.y * cellSize + cellSize / 2,
                cellSize / 2 - 2,
                0,
                2 * Math.PI
            );
            ctx.fill();
            
            // ç»˜åˆ¶è›‡
            snake.forEach((segment, index) => {
                const x = segment.x * cellSize;
                const y = segment.y * cellSize;
                
                if (index === 0) {
                    // ç»˜åˆ¶è›‡å¤´
                    if (config.skin === 'custom' && config.customSkin.enabled && config.customSkin.headImg) {
                        // è‡ªå®šä¹‰çš®è‚¤è›‡å¤´
                        ctx.drawImage(
                            config.customSkin.headImg,
                            x,
                            y,
                            cellSize,
                            cellSize
                        );
                    } else {
                        // é»˜è®¤çš®è‚¤è›‡å¤´
                        ctx.fillStyle = config.colors[config.skin].head;
                        ctx.fillRect(x, y, cellSize, cellSize);
                        
                        // ç»˜åˆ¶çœ¼ç›
                        ctx.fillStyle = config.colors[config.skin].eye;
                        const eyeSize = cellSize / 5;
                        if (dx === 1) { // å³
                            ctx.fillRect(x + cellSize - eyeSize * 2, y + eyeSize, eyeSize, eyeSize);
                            ctx.fillRect(x + cellSize - eyeSize * 2, y + cellSize - eyeSize * 2, eyeSize, eyeSize);
                        } else if (dx === -1) { // å·¦
                            ctx.fillRect(x + eyeSize, y + eyeSize, eyeSize, eyeSize);
                            ctx.fillRect(x + eyeSize, y + cellSize - eyeSize * 2, eyeSize, eyeSize);
                        } else if (dy === 1) { // ä¸‹
                            ctx.fillRect(x + eyeSize, y + cellSize - eyeSize * 2, eyeSize, eyeSize);
                            ctx.fillRect(x + cellSize - eyeSize * 2, y + cellSize - eyeSize * 2, eyeSize, eyeSize);
                        } else if (dy === -1) { // ä¸Š
                            ctx.fillRect(x + eyeSize, y + eyeSize, eyeSize, eyeSize);
                            ctx.fillRect(x + cellSize - eyeSize * 2, y + eyeSize, eyeSize, eyeSize);
                        }
                    }
                } else if (index === snake.length - 1) {
                    // ç»˜åˆ¶è›‡å°¾
                    if (config.skin === 'custom' && config.customSkin.enabled && config.customSkin.tailImg) {
                        // è‡ªå®šä¹‰çš®è‚¤è›‡å°¾
                        ctx.drawImage(
                            config.customSkin.tailImg,
                            x,
                            y,
                            cellSize,
                            cellSize
                        );
                    } else {
                        // é»˜è®¤çš®è‚¤è›‡å°¾
                        ctx.fillStyle = config.colors[config.skin].body;
                        ctx.fillRect(x, y, cellSize, cellSize);
                        
                        // ç»˜åˆ¶å°¾éƒ¨æ¸å˜
                        ctx.fillStyle = ctx.createLinearGradient(x, y, x + cellSize, y + cellSize);
                        ctx.fillStyle.addColorStop(0, config.colors[config.skin].body);
                        ctx.fillStyle.addColorStop(1, config.colors[config.skin].head);
                        ctx.fillRect(x, y, cellSize, cellSize);
                    }
                } else {
                    // ç»˜åˆ¶è›‡èº«
                    if (config.skin === 'custom' && config.customSkin.enabled && config.customSkin.bodyImg) {
                        // è‡ªå®šä¹‰çš®è‚¤è›‡èº«
                        ctx.drawImage(
                            config.customSkin.bodyImg,
                            x,
                            y,
                            cellSize,
                            cellSize
                        );
                    } else {
                        // é»˜è®¤çš®è‚¤è›‡èº«
                        ctx.fillStyle = config.colors[config.skin].body;
                        ctx.fillRect(x, y, cellSize, cellSize);
                    }
                }
                
                // ç»˜åˆ¶è¾¹æ¡†
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, cellSize, cellSize);
            });
        }

        // AI æœ€çŸ­è·¯å¾„ç®—æ³•
        function findShortestPath() {
            const start = { x: snake[0].x, y: snake[0].y };
            const end = { x: food.x, y: food.y };
            
            // BFS ç®—æ³•
            const queue = [start];
            const visited = new Set();
            const parent = {};
            
            visited.add(`${start.x},${start.y}`);
            
            while (queue.length > 0) {
                const current = queue.shift();
                
                // åˆ°è¾¾ç›®æ ‡
                if (current.x === end.x && current.y === end.y) {
                    // å›æº¯æ‰¾åˆ°ç¬¬ä¸€æ­¥
                    let step = current;
                    while (parent[`${step.x},${step.y}`] && parent[`${step.x},${step.y}`] !== `${start.x},${start.y}`) {
                        step = parent[`${step.x},${step.y}`];
                    }
                    
                    return {
                        x: step.x - start.x,
                        y: step.y - start.y
                    };
                }
                
                // å››ä¸ªæ–¹å‘
                const directions = [
                    { x: 0, y: -1 }, // ä¸Š
                    { x: 0, y: 1 },  // ä¸‹
                    { x: -1, y: 0 }, // å·¦
                    { x: 1, y: 0 }   // å³
                ];
                
                for (const dir of directions) {
                    const nextX = current.x + dir.x;
                    const nextY = current.y + dir.y;
                    
                    // æ£€æŸ¥è¾¹ç•Œå’Œè‡ªèº«
                    if (
                        nextX >= 0 && nextX < config.gridSize &&
                        nextY >= 0 && nextY < config.gridSize &&
                        !snake.some(seg => seg.x === nextX && seg.y === nextY) &&
                        !visited.has(`${nextX},${nextY}`)
                    ) {
                        visited.add(`${nextX},${nextY}`);
                        parent[`${nextX},${nextY}`] = current;
                        queue.push({ x: nextX, y: nextY });
                    }
                }
            }
            
            // æ²¡æœ‰æ‰¾åˆ°è·¯å¾„ï¼Œéšæœºç§»åŠ¨
            const randomDirs = [
                { x: 0, y: -1 },
                { x: 0, y: 1 },
                { x: -1, y: 0 },
                { x: 1, y: 0 }
            ].filter(dir => {
                const nx = start.x + dir.x;
                const ny = start.y + dir.y;
                return nx >= 0 && nx < config.gridSize && ny >= 0 && ny < config.gridSize &&
                       !snake.some(seg => seg.x === nx && seg.y === ny);
            });
            
            return randomDirs.length > 0 ? randomDirs[0] : null;
        }

        // æ¸¸æˆç»“æŸ
        function gameOver() {
            isGameOver = true;
            clearInterval(gameLoop);
            playSound('hit-sound');
            
            // ä¿å­˜æœ€é«˜åˆ†
            if (score > highest) {
                highest = score;
                localStorage.setItem('snakeHighest', highest);
                document.getElementById('high-score').innerText = highest;
                
                // ä¿å­˜åˆ°æ’è¡Œæ¦œ
                saveToRank();
            }
            
            // æ˜¾ç¤ºç»“æŸé¢æ¿
            dom.overPanel.style.display = 'flex';
            
            // ç”Ÿæˆæˆ˜æŠ¥
            generateSummary();
            
            // éšè—æ“æ§ç›˜
            if (joystick.container) {
                joystick.container.style.display = 'none';
            }
        }

        // ç”Ÿæˆæ¸¸æˆæ€»ç»“
        function generateSummary() {
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            document.getElementById('res-steps').innerText = moveRoute.length;
            document.getElementById('res-apples').innerText = appleCount;
            
            // æ›´æ–°éš¾åº¦æ˜¾ç¤º
            let diffText = 'ç®€å•';
            if (config.speed === 150) diffText = 'ä¸­ç­‰';
            else if (config.speed === 120) diffText = 'å›°éš¾';
            document.getElementById('res-difficulty').innerText = diffText;
            
            // æ›´æ–°æˆå°±æ ‡é¢˜
            let achievement = '[ ä¸›æ—èŒè›‡ ]';
            if (appleCount >= 5) achievement = '[ è›‡è¡Œåƒé‡Œ ]';
            if (appleCount >= 10) achievement = '[ è´ªé£Ÿå¤§è›‡ ]';
            if (appleCount >= 20) achievement = '[ è›‡ç‹é™ä¸´ ]';
            document.getElementById('achievement-title').innerText = achievement;
            
            // ç»˜åˆ¶è·¯çº¿æ€»ç»“
            drawRouteSummary();
        }

        // ç»˜åˆ¶è·¯çº¿æ€»ç»“
        function drawRouteSummary() {
            const sCanvas = document.getElementById('route-summary-map');
            const sCtx = sCanvas.getContext('2d');
            
            // æ¸…ç©ºç”»å¸ƒ
            sCtx.clearRect(0, 0, sCanvas.width, sCanvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            sCtx.fillStyle = '#fef9ef';
            sCtx.fillRect(0, 0, sCanvas.width, sCanvas.height);
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const scaleX = sCanvas.width / config.gridSize;
            const scaleY = sCanvas.height / config.gridSize;
            
            // ç»˜åˆ¶è·¯çº¿
            moveRoute.forEach((point, index) => {
                const x = point.x * scaleX;
                const y = point.y * scaleY;
                
                if (point.isApple) {
                    // ç»˜åˆ¶è‹¹æœ
                    sCtx.fillStyle = '#e74c3c';
                    sCtx.beginPath();
                    sCtx.arc(x + scaleX/2, y + scaleY/2, scaleX/3, 0, 2 * Math.PI);
                    sCtx.fill();
                } else {
                    // ç»˜åˆ¶ç§»åŠ¨è½¨è¿¹
                    sCtx.fillStyle = index === 0 ? '#e67e22' : 'rgba(243, 156, 18, 0.3)';
                    sCtx.fillRect(x, y, scaleX, scaleY);
                }
            });
            
            // ç»˜åˆ¶èµ·ç‚¹
            const start = moveRoute[0];
            sCtx.fillStyle = '#27ae60';
            sCtx.fillRect(start.x * scaleX, start.y * scaleY, scaleX, scaleY);
            
            // ç»˜åˆ¶ç»ˆç‚¹
            const end = moveRoute[moveRoute.length - 1];
            sCtx.fillStyle = '#e74c3c';
            sCtx.fillRect(end.x * scaleX, end.y * scaleY, scaleX, scaleY);
        }

        // ä¿å­˜åˆ°æ’è¡Œæ¦œ
        function saveToRank() {
            // è¯»å–ç°æœ‰æ•°æ®
            let rank = JSON.parse(localStorage.getItem('snakeRank') || '[]');
            
            // æ·»åŠ æ–°è®°å½•
            rank.push({
                score: score,
                apples: appleCount,
                steps: moveRoute.length,
                time: new Date().toLocaleString(),
                difficulty: config.speed === 200 ? 'ç®€å•' : (config.speed === 150 ? 'ä¸­ç­‰' : 'å›°éš¾')
            });
            
            // æ’åºå¹¶ä¿ç•™å‰10æ¡
            rank = rank.sort((a, b) => b.score - a.score).slice(0, 10);
            
            // ä¿å­˜
            localStorage.setItem('snakeRank', JSON.stringify(rank));
            
            // æ›´æ–°æ’è¡Œæ¦œæ•°æ®
            rankData = rank;
        }

        // åŠ è½½æœ€é«˜åˆ†
        function loadHighestScore() {
            highest = parseInt(localStorage.getItem('snakeHighest')) || 0;
            document.getElementById('high-score').innerText = highest;
        }

        // åŠ è½½æ’è¡Œæ¦œæ•°æ®
        function loadRankData() {
            rankData = JSON.parse(localStorage.getItem('snakeRank') || '[]');
        }

        // æ¸²æŸ“æ’è¡Œæ¦œ
        function renderRank() {
            const rankList = document.getElementById('rank-list');
            rankList.innerHTML = '';
            
            if (rankData.length === 0) {
                rankList.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">æš‚æ— è®°å½•</div>';
                return;
            }
            
            rankData.forEach((item, index) => {
                const rankItem = document.createElement('div');
                rankItem.className = 'rank-item';
                
                rankItem.innerHTML = `
                    <span class="rank-num">${index + 1}</span>
                    <span class="rank-score">${item.score}åˆ†</span>
                    <span class="rank-date">${item.time}</span>
                `;
                
                rankList.appendChild(rankItem);
            });
        }

        // é”®ç›˜æ§åˆ¶
        function handleKeydown(e) {
            if (isGameOver || isPaused) return;
            
            // æ–¹å‘é”®æ§åˆ¶
            switch(e.key) {
                case 'ArrowUp':
                    if (dy !== 1) {
                        dx = 0;
                        dy = -1;
                        config.dx = dx;
                        config.dy = dy;
                    }
                    break;
                case 'ArrowDown':
                    if (dy !== -1) {
                        dx = 0;
                        dy = 1;
                        config.dx = dx;
                        config.dy = dy;
                    }
                    break;
                case 'ArrowLeft':
                    if (dx !== 1) {
                        dx = -1;
                        dy = 0;
                        config.dx = dx;
                        config.dy = dy;
                    }
                    break;
                case 'ArrowRight':
                    if (dx !== -1) {
                        dx = 1;
                        dy = 0;
                        config.dx = dx;
                        config.dy = dy;
                    }
                    break;
            }
        }

        // æš‚åœ/ç»§ç»­æ¸¸æˆ
        function togglePause() {
            isPaused = !isPaused;
            dom.pausePanel.style.display = isPaused ? 'flex' : 'none';
            
            // æš‚åœæ—¶éšè—æ“æ§ç›˜
            if (joystick.container) {
                joystick.container.style.display = isPaused ? 'none' : (config.control === 'swipe' ? 'block' : 'none');
            }
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            startGame();
        }

        // è¿”å›é¦–é¡µ
        function backToHome() {
            clearInterval(gameLoop);
            isGameOver = false;
            isPaused = false;
            
            dom.gameHome.style.display = 'flex';
            dom.gameHeader.style.display = 'none';
            dom.gameWrapper.style.display = 'none';
            dom.overPanel.style.display = 'none';
            dom.pausePanel.style.display = 'none';
            
            // éšè—æ“æ§ç›˜
            if (joystick.container) {
                joystick.container.style.display = 'none';
            }
        }

        // ä¿å­˜ä¸ºå›¾ç‰‡ï¼ˆåˆ†äº«æˆ˜ç»©ï¼‰
        function saveAsImage() {
            const shareCard = document.querySelector('.share-card');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            canvas.width = shareCard.offsetWidth;
            canvas.height = shareCard.offsetHeight;
            
            // ç»˜åˆ¶å†…å®¹
            html2canvas(shareCard).then(canvas => {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.download = `è´ªåƒè›‡æˆ˜ç»©_${score}åˆ†.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(e => {
                alert('æˆªå›¾å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                console.error(e);
            });
        }
    </script>
    <!-- å¼•å…¥html2canvasç”¨äºæˆªå›¾ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
